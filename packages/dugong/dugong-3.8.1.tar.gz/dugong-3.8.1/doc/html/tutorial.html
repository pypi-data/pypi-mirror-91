
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Tutorial &#8212; Dugong 3.8.1 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Reference" href="api.html" />
    <link rel="prev" title="Introduction" href="intro.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="api.html" title="API Reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="Introduction"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Dugong 3.8.1 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<div class="section" id="basic-use">
<h2>Basic Use<a class="headerlink" href="#basic-use" title="Permalink to this headline">¶</a></h2>
<p>A HTTP request can be send and read in four lines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="s1">&#39;www.python.org&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/index.html&#39;</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">read_response</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">readall</span><span class="p">()</span>
</pre></div>
</div>
<p><a class="reference internal" href="api.html#dugong.HTTPConnection.send_request" title="dugong.HTTPConnection.send_request"><code class="xref py py-obj docutils literal notranslate"><span class="pre">send_request</span></code></a> is a <a class="reference internal" href="api.html#dugong.HTTPResponse" title="dugong.HTTPResponse"><code class="xref py py-obj docutils literal notranslate"><span class="pre">HTTPResponse</span></code></a> object that gives
access to the response header:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s1">&#39;Server said:&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%03d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
<span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</pre></div>
</div>
<p><a class="reference internal" href="api.html#dugong.HTTPConnection.readall" title="dugong.HTTPConnection.readall"><code class="xref py py-obj docutils literal notranslate"><span class="pre">HTTPConnection.readall</span></code></a> returns a a <a class="reference external" href="https://docs.python.org/3/glossary.html#term-bytes-like-object" title="(in Python v3.9)"><span class="xref std std-term">bytes-like object</span></a>. To
convert to text, you could do something like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">hit</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(.+?)(?:; charset=(.+))?$&#39;</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">])</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s2">&quot;Can&#39;t determine response charset&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">hit</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="c1"># found explicity charset</span>
    <span class="n">charset</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">hit</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;text/&#39;</span><span class="p">):</span>
    <span class="n">charset</span> <span class="o">=</span> <span class="s1">&#39;latin1&#39;</span> <span class="c1"># default for text/ types by RFC 2616</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s1">&#39;Server sent binary data&#39;</span><span class="p">)</span>
<span class="n">text_body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="ssl-connections">
<h2>SSL Connections<a class="headerlink" href="#ssl-connections" title="Permalink to this headline">¶</a></h2>
<p>If you would like to establish a secure connection, you need to pass
the appropriate <a class="reference external" href="https://docs.python.org/3/library/ssl.html#ssl.SSLContext" title="(in Python v3.9)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SSLContext</span></code></a> object to <a class="reference internal" href="api.html#dugong.HTTPConnection" title="dugong.HTTPConnection"><code class="xref py py-obj docutils literal notranslate"><span class="pre">HTTPConnection</span></code></a>. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ssl_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
<span class="n">ssl_context</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span>
<span class="n">ssl_context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
<span class="n">ssl_context</span><span class="o">.</span><span class="n">set_default_verify_paths</span><span class="p">()</span>

<span class="k">with</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="s1">&#39;www.google.com&#39;</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/index.html&#39;</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">read_response</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">readall</span><span class="p">()</span>
</pre></div>
</div>
<p>If you need information about the peer certificate, use the
<a class="reference internal" href="api.html#dugong.HTTPConnection.get_ssl_peercert" title="dugong.HTTPConnection.get_ssl_peercert"><code class="xref py py-obj docutils literal notranslate"><span class="pre">get_ssl_peercert</span></code></a> method.</p>
</div>
<div class="section" id="streaming-api">
<h2>Streaming API<a class="headerlink" href="#streaming-api" title="Permalink to this headline">¶</a></h2>
<p>When retrieving larger objects, it’s generally better not to read the
response body all at once but in smaller chunks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">BUFSIZE</span> <span class="o">=</span> <span class="mi">32</span><span class="o">*</span><span class="mi">1024</span> <span class="c1"># Read in 32 kB chunks</span>

<span class="c1"># ...</span>

<span class="n">conn</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/big_movie.mp4&#39;</span><span class="p">)</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">read_response</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;big_movie.mp4&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span>
           <span class="k">break</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</pre></div>
</div>
<p>Alternatively, the <a class="reference internal" href="api.html#dugong.HTTPConnection.readinto" title="dugong.HTTPConnection.readinto"><code class="xref py py-obj docutils literal notranslate"><span class="pre">readinto</span></code></a> method may give better
performance in some situations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;big_movie.mp4&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">len_</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">len_</span><span class="p">:</span>
           <span class="k">break</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="n">len_</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="uploading-data">
<h2>Uploading Data<a class="headerlink" href="#uploading-data" title="Permalink to this headline">¶</a></h2>
<p>If you want to send data to the server, you can provide the data
directly to <a class="reference internal" href="api.html#dugong.HTTPConnection.send_request" title="dugong.HTTPConnection.send_request"><code class="xref py py-obj docutils literal notranslate"><span class="pre">send_request</span></code></a>,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># A simple SQL injection attack for your favorite PHP script</span>
<span class="n">request_body</span> <span class="o">=</span> <span class="s2">&quot;&#39;; DELETE FROM passwords;&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;us-ascii&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="s1">&#39;somehost.com&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/form.php&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">request_body</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">read_response</span><span class="p">()</span>
</pre></div>
</div>
<p>or (if you want to send bigger amounts) you can provide it in multiple
chunks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;newest_release.mp4&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">st_size</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;/public/newest_release.mp4&#39;</span><span class="p">,</span>
                      <span class="n">body</span><span class="o">=</span><span class="n">BodyFollowing</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">read_response</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">204</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we used the special <a class="reference internal" href="api.html#dugong.BodyFollowing" title="dugong.BodyFollowing"><code class="xref py py-obj docutils literal notranslate"><span class="pre">BodyFollowing</span></code></a> class to indicate that the
request body data will be provided in separate calls.</p>
</div>
<div class="section" id="continue-support">
<h2>100-Continue Support<a class="headerlink" href="#continue-support" title="Permalink to this headline">¶</a></h2>
<p>When having to transfer large amounts of request bodies to the server,
you typically do not want to sent all the data over the network just
to find out that the server rejected the request because of
e.g. insufficient permissions. To avoid this situation, HTTP 1.1
specifies the <em>100-continue</em> mechanism. When using 100-continue, the
client transmits an additional <code class="docutils literal notranslate"><span class="pre">Expect:</span> <span class="pre">100-continue</span></code> request
header, and then waits for the server to reply with status <code class="docutils literal notranslate"><span class="pre">100</span>
<span class="pre">Continue</span></code> before sending the request body data. If the server instead
responds with an error, the client can avoid pointless transmission of
the request body.</p>
<p>To use this mechanism, pass the <em>expect100</em> parameter to
<a class="reference internal" href="api.html#dugong.HTTPConnection.send_request" title="dugong.HTTPConnection.send_request"><code class="xref py py-obj docutils literal notranslate"><span class="pre">send_request</span></code></a>, and call
<a class="reference internal" href="api.html#dugong.HTTPConnection.read_response" title="dugong.HTTPConnection.read_response"><code class="xref py py-obj docutils literal notranslate"><span class="pre">read_response</span></code></a> twice: once before sending body data,
and a second time to read the final response:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;newest_release.mp4&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">st_size</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;/public/newest_release.mp4&#39;</span><span class="p">,</span>
                      <span class="n">body</span><span class="o">=</span><span class="n">BodyFollowing</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">expect100</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">read_response</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Server said: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">resp</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">read_response</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">204</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="retrying-on-error">
<h2>Retrying on Error<a class="headerlink" href="#retrying-on-error" title="Permalink to this headline">¶</a></h2>
<p>Sometimes the connection to the remote server may get interrupted for
a variety of reasons, resulting in a variety of exceptions. For
convience, you may use the <a class="reference internal" href="api.html#dugong.is_temp_network_error" title="dugong.is_temp_network_error"><code class="xref py py-obj docutils literal notranslate"><span class="pre">is_temp_network_error</span></code></a> method to determine if a
given exception indicates a temporary problem (i.e., if it makes sense
to retry):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">delay</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="s1">&#39;www.python.org&#39;</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/index.html&#39;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">read_response</span><span class="p">()</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">readall</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_temp_network_error</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Got </span><span class="si">%s</span><span class="s1">, retrying..&#39;</span> <span class="o">%</span> <span class="n">exc</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
            <span class="n">delay</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="timing-out">
<h2>Timing out<a class="headerlink" href="#timing-out" title="Permalink to this headline">¶</a></h2>
<p>It can take quite a long time before the operation system recognises
that a TCP/IP connection has been interrupted. If you’d rather be
informed right away when there has been no data exchange for some
period of time, dugong allows you to specify a custom timeout:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="s1">&#39;www.python.org&#39;</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/index.html&#39;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">read_response</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">readall</span><span class="p">()</span>
<span class="k">except</span> <span class="n">ConnectionTimedOut</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Unable to send or receive any data for more than&#39;</span><span class="p">,</span>
          <span class="n">conn</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="s1">&#39;seconds, aborting.&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="pipelining-with-threads">
<span id="pipelining"></span><h2>Pipelining with Threads<a class="headerlink" href="#pipelining-with-threads" title="Permalink to this headline">¶</a></h2>
<p>Pipelining means sending multiple requests in succession, without
waiting for the responses. First, let’s consider how do <strong>not</strong> do it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># DO NOT DO THIS!</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="s1">&#39;somehost.com&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_list</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

<span class="n">bodies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_list</span><span class="p">:</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">read_response</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">bodies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">readall</span><span class="p">())</span>
</pre></div>
</div>
<p>This will probably even work as long as you don’t have too many
elements in <em>path_list</em>. However, it is very bad practice, because at
some point the server will stop reading requests until some responses
have been read (because all the TCP buffers are full). At this point,
your application will deadlock.</p>
<p>One better way do it is to use threads. Dugong is not generally
threadsafe, but using one thread to send requests and one thread to
read responses is supported:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="s1">&#39;somehost.com&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">send_requests</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_list</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">send_requests</span><span class="p">)</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">bodies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_list</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">read_response</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="n">bodies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">readall</span><span class="p">())</span>

    <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<p>Another way is to use coroutines. This is explained in the next
section.</p>
</div>
<div class="section" id="pipelining-with-coroutines">
<span id="coroutine-pipelining"></span><h2>Pipelining with Coroutines<a class="headerlink" href="#pipelining-with-coroutines" title="Permalink to this headline">¶</a></h2>
<p>Instead of using two threads to send requests and responses, you can
also use two coroutines. A coroutine is essentially a function that
can be suspended and resumed at specific points. Dugong coroutines
suspend themself when they would have to wait for an I/O operation to
complete. This makes them perfect for pipelining: we’ll define one
coroutine that sends requests, and a second one to read responses, and
then execute them “interleaved”: whenever we can’t send another
request, we try to read a response, and if we can’t read a response,
we try to send another request.</p>
<p>The following example demonstrates how to do this to efficiently
retrieve a large number of documents (stored in <em>url_list</em>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">from</span> <span class="nn">dugong</span> <span class="kn">import</span> <span class="n">HTTPConnection</span><span class="p">,</span> <span class="n">AioFuture</span>

<span class="c1"># Get a MainLoop instance from the asyncio module to switch</span>
<span class="c1"># between coroutines (and clean up at program exit)</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>

<span class="k">with</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="c1"># This generator function returns a coroutine that sends</span>
    <span class="c1"># all the requests.</span>
    <span class="k">def</span> <span class="nf">send_requests</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_list</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">conn</span><span class="o">.</span><span class="n">co_send_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="c1"># This generator function returns a coroutine that reads</span>
    <span class="c1"># all the responses</span>
    <span class="k">def</span> <span class="nf">read_responses</span><span class="p">():</span>
        <span class="n">bodies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_list</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">conn</span><span class="o">.</span><span class="n">co_read_response</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">conn</span><span class="o">.</span><span class="n">co_readall</span><span class="p">()</span>
            <span class="n">bodies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bodies</span>

    <span class="c1"># Create the coroutines</span>
    <span class="n">send_crt</span> <span class="o">=</span> <span class="n">send_requests</span><span class="p">()</span>
    <span class="n">recv_crt</span> <span class="o">=</span> <span class="n">read_responses</span><span class="p">()</span>

    <span class="c1"># Register the coroutines with the event loop</span>
    <span class="n">send_future</span> <span class="o">=</span> <span class="n">AioFuture</span><span class="p">(</span><span class="n">send_crt</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>
    <span class="n">recv_future</span> <span class="o">=</span> <span class="n">AioFuture</span><span class="p">(</span><span class="n">recv_crt</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>

    <span class="c1"># Run the event loop until the receive coroutine is done (which</span>
    <span class="c1"># implies that all the requests must have been sent as well):</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">recv_future</span><span class="p">)</span>

    <span class="c1"># Get the result returned by the coroutine</span>
    <span class="n">bodies</span> <span class="o">=</span> <span class="n">recv_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

</pre></div>
</div>
<p>Here we have used the <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#yieldexpr" title="(in Python v3.9)"><span class="xref std std-ref">yield from expression</span></a> to
integrate the coroutines returned by
<a class="reference internal" href="api.html#dugong.HTTPConnection.co_send_request" title="dugong.HTTPConnection.co_send_request"><code class="xref py py-obj docutils literal notranslate"><span class="pre">co_send_request</span></code></a>, <a class="reference internal" href="api.html#dugong.HTTPConnection.co_read_response" title="dugong.HTTPConnection.co_read_response"><code class="xref py py-obj docutils literal notranslate"><span class="pre">co_read_response</span></code></a>,
and <a class="reference internal" href="api.html#dugong.HTTPConnection.co_readall" title="dugong.HTTPConnection.co_readall"><code class="xref py py-obj docutils literal notranslate"><span class="pre">co_readall</span></code></a> into two custom coroutines
<em>send_requests</em> and <em>read_responses</em>. To schedule the coroutines, we
use <a class="reference internal" href="api.html#dugong.AioFuture" title="dugong.AioFuture"><code class="xref py py-obj docutils literal notranslate"><span class="pre">AioFuture</span></code></a> to obtain <a class="reference external" href="https://docs.python.org/3/library/asyncio-future.html#asyncio.Future" title="(in Python v3.9)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">asyncio</span> <span class="pre">Futures</span></code></a> for them,
and then rely on the <a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(in Python v3.9)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code></a> module to do the heavy lifting and
switch execution between them at the right times.</p>
<p>For more details about this, take a look at <a class="reference internal" href="coroutines.html#coroutines"><span class="std std-ref">Coroutine API</span></a>, or the
<a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(in Python v3.9)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">asyncio</span> <span class="pre">documentation</span></code></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="index.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#basic-use">Basic Use</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ssl-connections">SSL Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="#streaming-api">Streaming API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#uploading-data">Uploading Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#continue-support">100-Continue Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="#retrying-on-error">Retrying on Error</a></li>
<li class="toctree-l2"><a class="reference internal" href="#timing-out">Timing out</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pipelining-with-threads">Pipelining with Threads</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pipelining-with-coroutines">Pipelining with Coroutines</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="coroutines.html">Coroutine API</a></li>
<li class="toctree-l1"><a class="reference internal" href="issues.html">Known Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html">Changelog</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="intro.html"
                        title="previous chapter">Introduction</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="api.html"
                        title="next chapter">API Reference</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="api.html" title="API Reference"
             >next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="Introduction"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Dugong 3.8.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013-2014, Nikolaus Rath.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
  </body>
</html>