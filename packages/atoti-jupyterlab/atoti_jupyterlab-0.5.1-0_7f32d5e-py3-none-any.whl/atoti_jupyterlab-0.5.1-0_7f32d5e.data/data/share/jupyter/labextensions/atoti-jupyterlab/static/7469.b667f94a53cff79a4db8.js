(self.webpackChunkatoti_jupyterlab=self.webpackChunkatoti_jupyterlab||[]).push([[7469],{34380:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>Ct});var n=s(3265);const i="Content-Type",o="application/json",a=(e,{requestInit:t={}}={})=>async(s,{body:n,contentType:a=o,method:r}={})=>{const d=`${e}/${s.startsWith("/")?s.slice(1):s}`,l=await fetch(d,{...t,body:n,headers:{...t.headers,...a?{[i]:a}:{}},method:r});if(![200,201].includes(l.status)){const e=await l.json();throw console.error(e),new Error(`Unexpected response status: ${l.status}`)}const c=l.headers.get(i)===o,u=await(c?l.json():l.text());return c?u.data:u},r="ROLE_ADMIN",d="anonymousUser";var l=s(97030),c=s.n(l);const u=e=>void 0!==e,h=(...e)=>{if(!window.__UNSTABLE_DATA_TEST_IDS_ENABLED__)return;const t=e[e.length-1];if(c()(t)){const s=t["data-testid"],n=e.slice(0,-1).filter(u);if(s){const e=s.replace("atoti:","");return`atoti:${n.filter(u).concat(e).join(":")}`}return`atoti:${n.join(":")}`}return`atoti:${e.filter(u).join(":")}`};var g=s(36574),p=s(83028),m=s(40910),w=s(40129),x=s(54171),y=s(29383),v=s(56271);const C="ant-root",S=(0,v.forwardRef)((({children:e,height:t,...s},n)=>(0,y.jsx)("div",Object.assign({},s,{ref:n,className:C,css:{height:t}}),e)));var f=s(6168),j=s(20391);const b="en-US",k={en:"en-US"},E=e=>{if(!e)return b;const t=e.get("locale").composite,s=k[t];return void 0===s?(console.error(`atoti does not support JupyterLab's ${t} locale, falling back to en-US.`),b):s},M=async(e,t)=>{const[n,{default:i}]=await Promise.all([(0,x.pr1)(t,e),s(7147)(`./${e}`)]);return{...n,...(0,j.treeToFlatMap)(i)}};class _{constructor(e,t,s){this._changed=new f.Signal(this),this._config=e,s&&s.changed.connect((async()=>{const e=E(s),n=await M(e,t);this._config={locale:e,messages:n},this._changed.emit()}))}static async create(e,t){const s=await(t?t.load("@jupyterlab/translation-extension:plugin"):void 0),n=E(s),i=await M(n,e);return new _({locale:n,messages:i},e,s)}get changed(){return this._changed}get config(){return this._config}}var I=s(24350),L=s.n(I),T=s(69043),R=s(35411),U=s(15542),$=s(77641);class O{constructor({activePivotClient:e,contentClient:t,dataModel:s,fetch:n,isQuerySession:i,unproxiedUrl:o,url:a}){this._dataModelChanged=new f.Signal(this),this._disposed=new f.Signal(this),this._isDisposed=!1,this._dataModel=s,this.activePivotClient=e,this.appUrl=""===new URL(a).pathname?a:`${a}/`,this.contentClient=t,this.fetch=n,this.unsubscribeToDataModel=i?()=>{}:(({onChange:e,onDisconnect:t=(()=>{}),url:s})=>{let n=!1;const i=s.replace(/^(http)(s)?:\/\//,"ws$2://"),o=`${i.endsWith("/")?i:`${i}/`}atoti/discovery`,a=new WebSocket(o);return a.addEventListener("message",(({data:t})=>{const s=JSON.parse(t);e(s)})),a.addEventListener("close",(async()=>{n||(n=!0,t())})),()=>{n||(n=!0,a.close())}})({onChange:e=>{this._dataModel=e,this._dataModelChanged.emit()},onDisconnect:()=>{this.dispose()},url:a}),this.isQuerySession=i,this.unproxiedUrl=o}static async create(e,t,s,n,i){const o=null===e?void 0:{credentials:"include",headers:e,mode:"cors"},r=i.apis.pivot.versions[0];await(0,x.qE7)(n,r,o);const d=new x.C68({requestInit:o,url:n,version:r}),l=new x.LyX({requestInit:o,url:n,version:i.apis.content.versions[0]}),c=await d.fetchDataModel(),u=a(n,{requestInit:o});return new O({activePivotClient:d,contentClient:l,dataModel:c,fetch:u,isQuerySession:t,unproxiedUrl:s,url:n})}get dataModel(){return this._dataModel}get dataModelChanged(){return this._dataModelChanged}dispose(){this.isDisposed||(this._isDisposed=!0,this._disposed.emit(),this.activePivotClient.dispose(),this.unsubscribeToDataModel(),f.Signal.clearData(this))}get disposed(){return this._disposed}get isDisposed(){return this._isDisposed}isSameQuerySession({isQuerySession:e,url:t}){return this.isQuerySession&&e&&this.unproxiedUrl===t}}var N=s(61162);const P=({children:e,icon:t,id:s})=>{const{formatMessage:n}=(0,U.useIntl)();return(0,y.jsx)("div",{css:{display:"flex",flexDirection:"column",height:"100%",justifyContent:"center"}},(0,y.jsx)(N.default,{description:(0,y.jsx)("span",{css:{color:"var(--jp-ui-font-color1)"}},(0,y.jsx)("span",{css:{fontSize:"var(--jp-ui-font-size2)"}},n({id:`${s}.title`})),(0,y.jsx)("br",null),(0,y.jsx)("span",{css:{color:"var(--jp-ui-font-color2)",fontSize:"var(--jp-ui-font-size1)"}},n({id:`${s}.description`}))),image:t,imageStyle:{fontSize:42,height:60}},e))},A=({hasSnapshot:e})=>e?(0,y.jsx)(P,{icon:(0,y.jsx)(T.PictureOutlined,null),id:"widget.snapshotSelected"}):(0,y.jsx)(P,{icon:(0,y.jsx)(T.ApiOutlined,null),id:"widget.waitingForConnection"});var D=s(50308),W=s.n(D),q=s(93100);const B=(e,t)=>{const s=(0,v.useCallback)((t=>e?(e.connect(t),()=>{e.disconnect(t)}):W()),[e]);return(0,q.useSubscription)({getCurrentValue:t,subscribe:s})},z=(e,t,s)=>{const n=(0,v.useCallback)((()=>{if(t)return t[s]}),[s,t]);return B(e,n)},F=(0,v.createContext)(void 0),Q=()=>(0,v.useContext)(F),H=(0,v.createContext)(void 0),K=({children:e,jupyterSessionContext:t,sessionName:s})=>{const n=Q(),i=z(null==t?void 0:t.sessionChanged,t,"session"),o=(0,v.useCallback)((()=>{const e=null==i?void 0:i.id;return e?n.get({jupyterSessionId:e,sessionName:s}):void 0}),[i,n,s]),a=B(n.changed,o),r=z(null==a?void 0:a.dataModelChanged,a,"dataModel"),d=(0,v.useMemo)((()=>{const e={};return a&&(e.default=a.activePivotClient),e}),[a]),l=(0,v.useMemo)((()=>null==a?void 0:a.contentClient),[a]),c=(0,v.useMemo)((()=>{const e={};return r&&(e.default=r),e}),[r]);return a?(e=>Object.values(e).some((({catalogs:e})=>e.some((({cubes:e})=>e.length>0)))))(c)?(0,y.jsx)(x.u_E,{value:{activePivot:d,content:l}},(0,y.jsx)(x.JjR,{value:c},(0,y.jsx)(H.Provider,{value:a},e))):(0,y.jsx)(P,{icon:(0,y.jsx)(x.qEg,null),id:"widget.noCubesToVisualize"}):(0,y.jsx)(A,null)};var X=s(42923);const J=({jupyterSessionId:e,sessionName:t})=>JSON.stringify(`${e}:${t}`),V=X.URLExt.join(X.PageConfig.getBaseUrl(),"proxy");class Y{constructor(){this._changed=new f.Signal(this),this.sessionClients={},this.sessionClientCreations={}}get changed(){return this._changed}async create({headers:e,isQuerySession:t,port:s,url:n}){let i,o=n;if(a=n,[new URL(X.PageConfig.getBaseUrl()).hostname,"localhost","127.0.0.1","","0.0.0.0"].includes(new URL(a).hostname)){const{pathname:e}=new URL(n),t=X.URLExt.join(V,String(s),...e&&"/"!==e?[e]:[]);try{const e=await(0,x.r66)(t);if(!e||!e.apis)throw new Error(`Unexpected versions: ${JSON.stringify(e)}`);i=e,o=t}catch(e){}}var a;return i||(i=await(0,x.r66)(o)),O.create(e,t,n,o,i)}get({jupyterSessionId:e,sessionName:t}){const s=J({jupyterSessionId:e,sessionName:t});return this.sessionClients[s]}async getOrCreate({jupyterSessionId:e,session:t,sessionName:s}){let n=this.get({jupyterSessionId:e,sessionName:s});if(n){if(!n.isSameQuerySession(t))return n;n.dispose()}const i=J({jupyterSessionId:e,sessionName:s});return i in this.sessionClientCreations||(this.sessionClientCreations[i]=Promise.resolve().then((async()=>{const e=await this.create(t),s=()=>{Reflect.deleteProperty(this.sessionClients,i),this._changed.emit(),e.disposed.disconnect(s)};e.disposed.connect(s),this.sessionClients[i]=e,Reflect.deleteProperty(this.sessionClientCreations,i),this._changed.emit()}))),await this.sessionClientCreations[i],this.sessionClients[i]}}const G=(0,v.createContext)(null),Z=G.Provider,ee=()=>(0,v.useContext)(G),te="publish-widget",se={Component:e=>{const{formatMessage:t,locale:s,messages:n}=(0,U.useIntl)(),i=(0,$.useMountedState)(),{appUrl:o,contentClient:a,isQuerySession:d}=(0,v.useContext)(H),l=ee(),[c,u]=(0,v.useState)(!1),{widgetState:h}=e,g=(0,v.useCallback)((()=>{(async()=>{u(!0);const{name:e,widgetKey:d,...c}=(0,x.XdI)(h),g=()=>{i()&&u(!1)},p=[r];try{await a.createFile({content:c,metaData:{name:l||void 0,widgetKey:d},owners:p,pathToFolder:[],readers:p,type:"widget"}),x.t6Z.success({description:(0,y.jsx)(U.IntlProvider,{locale:s,messages:n},(0,y.jsx)(U.FormattedMessage,{id:`aui.plugins.menu-item.${te}.successDescription`,values:{a:e=>(0,y.jsx)("a",{href:o,target:"_blank",rel:"noopener noreferrer"},e)}})),message:t({id:`aui.plugins.menu-item.${te}.successMessage`}),onClose:g})}catch(e){console.error(e),x.t6Z.error({description:String(e),message:t({id:`aui.plugins.menu-item.${te}.errorMessage`}),onClose:g})}})()}),[o,a,t,i,s,n,l,h]);return(0,y.jsx)(R.default,Object.assign({},(0,x.IWr)(e),{disabled:d||c,title:d?t({id:`aui.plugins.menu-item.${te}.querySessionWidgetsCannotBePublished`}):void 0,onClick:g}),(0,y.jsx)(v.Fragment,null,(0,y.jsx)(T.ShareAltOutlined,null),t({id:`aui.plugins.menu-item.${te}.publishWidgetInApp`})))},key:te,translations:{"en-US":{errorMessage:"Widget could not be published",publishWidgetInApp:"Publish in app",querySessionWidgetsCannotBePublished:"Query session widgets cannot be published",successDescription:'Find it in the "Widgets" drawer of <a>the app</a>.',successMessage:"Widget published"}}},ne=[x.Uk4,x.QYw,x.WaG,x.yNZ,x.XWS,x.lJ3],ie=[x.fyd,x.ikX],oe=e=>L()(e,"key");var ae=s(42355);const re=e=>{const t=z(e.activeCellChanged,e,"activeCell");if(t&&(0,ae.isCodeCellModel)(t.model))return t.model};var de=s(88306),le=s.n(de);class ce{constructor(e,t){this.isUndoingOrRedoing=!1,this.index=0,this.states=[e],this.onChange=()=>{this.isUndoingOrRedoing=!0;try{t(this.states[this.index])}finally{this.isUndoingOrRedoing=!1}}}get canRedo(){return this.index<this.states.length-1}get canUndo(){return this.index>0}set(e){this.isUndoingOrRedoing||(this.index++,this.states.length=this.index,this.states.push(e))}redo(){if(!this.canRedo)throw new Error("Cannot redo");this.index++,this.onChange()}undo(){if(!this.canUndo)throw new Error("Cannot undo");this.index--,this.onChange()}}const ue="atoti",he=360,ge=e=>e.get(ue)||void 0,pe=e=>{var t;return(null===(t=ge(e))||void 0===t?void 0:t.height)||he};class me{constructor(e,t){this._changed=new f.Signal(this),this._isDisposed=!1,this.cellMetadata=e,this.undoableState=new ce(this.current,(e=>{this.current=e}));const s=(e,{key:t,newValue:s})=>{t===ue&&(this.undoableState.set(s),this._changed.emit())};this.cellMetadata.changed.connect(s),this.disconnectFromCellMetadataChangedSignal=()=>{this.cellMetadata.changed.disconnect(s)},this.getDataVisualizationWidgetState=le()((e=>{if(e)return(0,x.cRp)(e)})),this.widgetPlugins=t}get defaultWidgetState(){return this.widgetPlugins[0].initialState}get canRedo(){return this.undoableState.canRedo}get canUndo(){return this.undoableState.canUndo}get changed(){return this._changed}get current(){return ge(this.cellMetadata)}set current(e){e?this.cellMetadata.set(ue,e):this.cellMetadata.delete(ue)}dispose(){this.isDisposed||(this._isDisposed=!0,this.disconnectFromCellMetadataChangedSignal(),f.Signal.clearData(this))}get isDisposed(){return this._isDisposed}setHeight(e){this.setMetadataProperty("height",e)}setMetadataProperty(e,t){const s=this.current;this.current={...s,[e]:t}}setStringifiedWidgetState(e){this.setMetadataProperty("widget",e)}setWidgetState(e){this.setStringifiedWidgetState((0,x.XdI)(e))}redo(){this.undoableState.redo()}undo(){this.undoableState.undo()}}const we=e=>{const t=(0,v.useCallback)((t=>{e.setWidgetState(t)}),[e]),{widget:s}=z(e.changed,e,"current")||{};return{setWidgetState:t,widgetState:e.getDataVisualizationWidgetState(s)}},xe=(0,v.createContext)(void 0),ye=()=>(0,v.useContext)(xe),ve=(0,v.createContext)(void 0),Ce=({cellMetadata:e,children:t,hasSnapshot:s})=>{const n=ye(),i=(0,v.useCallback)((()=>n.get(e)),[e,n]),o=B(n.created,i);return o?(0,y.jsx)(ve.Provider,{value:o},t):(0,y.jsx)(A,{hasSnapshot:s})},Se=()=>(0,v.useContext)(ve);class fe{constructor(e){this._created=new f.Signal(this),this.widgetStateTrackers=new WeakMap,this.widgetPlugins=e}get created(){return this._created}get(e){return this.widgetStateTrackers.get(e)}getOrCreate(e){return this.widgetStateTrackers.has(e)||(this.widgetStateTrackers.set(e,new me(e,this.widgetPlugins)),this._created.emit()),this.get(e)}}const je=["undo","redo"],be=({undoRedoKey:e,...t})=>{const{formatMessage:s}=(0,U.useIntl)(),n=Se();z(n.changed,n,"current");const i=(0,v.useCallback)((()=>{"undo"===e?n.undo():n.redo()}),[e,n]),o="undo"===e?!n.canUndo:!n.canRedo;return(0,y.jsx)(R.default,Object.assign({},(0,x.IWr)(t),{disabled:!n||o,title:o?s({id:`aui.plugins.menu-item.${e}.nothingToUndoRedo`}):void 0,onClick:i}),"undo"===e?(0,y.jsx)(T.UndoOutlined,null):(0,y.jsx)(T.RedoOutlined,null),s({id:`aui.plugins.menu-item.${e}.key`}))},ke=(e,t,s)=>n=>{const i=re(t);if(!i)throw new Error("Expected a notebook cell to be active");return(0,y.jsx)(xe.Provider,{value:s},(0,y.jsx)(Ce,{cellMetadata:i.metadata},(0,y.jsx)(be,Object.assign({undoRedoKey:e},n))))};var Ee=s(71249);const Me="atoti-sidebar";var _e=s(66510),Ie=s(19758),Le=s(91725);const Te=(0,v.createContext)(void 0),Re=(0,v.createContext)(void 0),Ue=({children:e,value:{intlTracker:t,jupyterLab:s,notebookTracker:n,pluginRegistry:i,sessionClients:o,themeTracker:a,widgetStateTrackers:r}})=>{const{locale:d,messages:l}=z(t.changed,t,"config"),c=z(a.changed,a,"palette");return(0,y.jsx)(Ie.DndProvider,{backend:Le.HTML5Backend},(0,y.jsx)(U.IntlProvider,{locale:d,messages:l},(0,y.jsx)(x.Xw_,{value:c},(0,y.jsx)(x.oPk,{value:i},(0,y.jsx)(Te.Provider,{value:s},(0,y.jsx)(Re.Provider,{value:n},(0,y.jsx)(F.Provider,{value:o},(0,y.jsx)(xe.Provider,{value:r},e))))))))},$e=(e,t)=>{for(let s=0;s<e.length;s++){const n=e.get(s);if(t(n))return n}},Oe=`application/vnd.atoti.v${"0.5.1".split(".",1).pop()}+json`;var Ne=s(21469),Pe=s(88808);const Ae=()=>{const e=Se(),{formatMessage:t}=(0,U.useIntl)();return(0,y.jsx)(P,{icon:(0,y.jsx)(T.MehOutlined,null),id:"widget.errored"},(0,y.jsx)(Ne.default,{danger:!0,onClick:()=>{e.current=void 0}},(0,y.jsx)(T.ClearOutlined,null)," ",t({id:"widget.reset"})),e.canUndo?(0,y.jsx)(Ne.default,{css:{marginLeft:"4px !important",marginTop:"4px !important"},onClick:()=>{e.undo()}},(0,y.jsx)(T.UndoOutlined,null)," ",t({id:"aui.plugins.menu-item.undo.key"})):null)},De=({children:e,widgetLoadingTracker:t})=>{const s=(0,v.useCallback)((async e=>{t&&await t.handleError(e)}),[t]),n=Se(),i=we(n);return(0,y.jsx)(Pe.ErrorBoundary,{FallbackComponent:Ae,resetKeys:[i],onError:s},e)},{OptGroup:We,Option:qe}=x.PhF,Be=({onChange:e,widgetState:t})=>{const{formatMessage:s}=(0,U.useIntl)(),n=(0,x.ANR)(),i=(0,x.h0_)(n),[{widgetKey:o}]=(0,x.ZrG)(t),a={};return Object.values(i).forEach((e=>{const t=e.subCategory||"misc",n=e.Icon||T.QuestionOutlined;a[t]||(a[t]=[]),a[t].push((0,y.jsx)(qe,{key:e.key,value:e.key},(0,y.jsx)(n,{css:{marginRight:4}})," ",s({id:`aui.plugins.widget.${e.key}.key`})))})),(0,y.jsx)(x.PhF,{css:{marginBottom:"4px !important",width:"100%"},listHeight:30*Object.keys(i).length,value:o,onChange:s=>{e((0,Ee.produce)(t,(e=>{s===e.widgetKey?delete e.switchedTo:e.switchedTo=s})))}},Object.entries(a).map((([e,t])=>(0,y.jsx)(We,{key:e,label:s({id:`aui.dataVisualization.category.${e}`})},t))))},ze=({queryId:e})=>{const t=Se(),{setWidgetState:s,widgetState:n=t.defaultWidgetState}=we(t),[i,o]=(0,x.ZrG)(n),a=o.contentEditor;return(0,y.jsx)(De,null,(0,y.jsx)("div",{css:{display:"flex",flexDirection:"column",height:"100%"}},(0,y.jsx)(Be,{widgetState:n,onChange:s}),(0,y.jsx)(a,{widgetState:n,queryId:e,onWidgetChange:s})))},Fe=()=>{const e=(0,v.useContext)(Re),t=re(e),s=(e=>{const t=z(e.currentChanged,e,"currentWidget");return t?t.sessionContext:void 0})(e),n=(e=>{z(null==e?void 0:e.outputs.changed,null==e?void 0:e.outputs,"length");const t=e?$e(e.outputs,(e=>void 0!==e.data[Oe])):void 0;if(!t)return;const{data:s}=t;return{snapshot:s["text/html"],widgetOutput:s[Oe]}})(t);if(!t||!n)return(0,y.jsx)(P,{icon:(0,y.jsx)(x.Iwf,null),id:"sidebar.noWidgetSelected"});const{snapshot:i,widgetOutput:{session:o}}=n;return(0,y.jsx)(Ce,{cellMetadata:t.metadata,hasSnapshot:Boolean(i)},(0,y.jsx)(K,{jupyterSessionContext:s,sessionName:o},(0,y.jsx)(ze,{queryId:t.id})))},Qe=".atoti-icon.jp-SideBar-tabIcon";class He extends _e.Widget{constructor(e){super(),this.id=Me,this.title.caption="atoti",this.title.iconClass="jp-SideBar-tabIcon atoti-icon";const t=p.ReactWidget.create((0,y.jsx)(v.Fragment,null,(0,y.jsx)(y.Global,{styles:{[Qe]:{backgroundColor:"var(--md-grey-700)",backgroundImage:"none",maskImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cg%3E%3Cpath d='M.24 11.88c0-4.43 2.74-7.82 7.05-7.82 1.9-.09 3.7.88 4.65 2.52V4.46h4.68V19.3h-4.68v-2.09c-.8 1.48-2.65 2.49-4.71 2.49-4.43 0-6.99-3.35-6.99-7.82m11.89 0c0-2.13-1.2-3.88-3.54-3.88-2.19 0-3.54 1.63-3.54 3.88s1.35 3.91 3.54 3.91c2.34 0 3.54-1.75 3.54-3.91' /%3E%3Cpath d='M17.91 16.81a2.917 2.917 0 012.96-2.88c1.58.02 2.86 1.3 2.89 2.88a2.947 2.947 0 01-2.97 2.89 2.929 2.929 0 01-2.88-2.89' /%3E%3C/g%3E%3C/svg%3E%0A\")",maskPosition:"center",maskRepeat:"no-repeat",maskSize:"contain"},[`[data-jp-theme-light="false"] ${Qe}`]:{backgroundColor:"var(--md-grey-300)"}}}),(0,y.jsx)(Ue,{value:e},(0,y.jsx)(Fe,null)))),{classList:s,style:n}=t.node;s.add(C),n.padding="4px 4px 0 4px";let i=new _e.PanelLayout;i.addWidget(t),this.layout=i}}const Ke="atoti-ant-style";class Xe{constructor(e,t,s){this._changed=new f.Signal(this),this._palette=e,s.themeChanged.connect((async()=>{this._palette=await t(),this._changed.emit()}))}static async create(e){const t=document.createElement("style");t.id=Ke,t.setAttribute("rel","stylesheet"),document.querySelector("head").append(t);const n=async()=>{const n=!e.theme||e.isLight(e.theme),i=n?await s.e(2872).then(s.t.bind(s,42872,17)):await s.e(3741).then(s.t.bind(s,13741,17));return t.innerHTML=i.default,(0,x.r8N)(n?x.ikX:x.fyd)},i=await n();return new Xe(i,n,e)}get changed(){return this._changed}get palette(){return this._palette}}var Je=s(19850),Ve=s(19129);class Ye{constructor(e){this._changed=new f.Signal(this),this.messages=new WeakMap,this.cells=e}get changed(){return this._changed}get(e){return this.messages.get(e)}register(e){this._changed.emit(),e.registerCommTarget("atoti-widget",((e,{content:{data:t}})=>{const s=t;try{const{cellId:e}=s;(({session:{headers:e,isQuerySession:t}})=>{if(!t){const t=new Headers(e).get("authorization");if(!t)throw new Error(`Missing Authorization header in ${JSON.stringify(e)}.`);const{username:s}=(e=>{const{authorities:t,sub:s}=JSON.parse(atob(e.split(".",2).pop())),n={roles:t,username:s},{roles:i,username:o}=n;if(!(o!==d||i.includes("ROLE_USER")&&i.includes(r)))throw new Error(`Anonymous user should have roles ROLE_USER and ROLE_ADMIN but had roles: ${i}.`);return n})(t.split(" ",2).pop());if(s!==d)throw new Error(`Expected username to be anonymousUser but was ${s}.`)}})(s);const t=(0,Je.toArray)(this.cells).find((({id:t})=>e===t));if(!t)throw new Error(`Missing model for cell #${e}`);if(!(0,ae.isCodeCellModel)(t))throw new Error(`Expected cell #${e} to be a code cell`);const n=$e(t.outputs,(e=>void 0!==e.data[Oe]));if(!n)throw new Error(`Expected cell #${e} to have a widget output`);this.messages.set(n,s),this._changed.emit()}catch(e){console.error(e)}}))}}var Ge=s(14456),Ze=s.n(Ge);const et=({children:e})=>{const[t,s]=(0,v.useState)(),n=(0,v.useRef)(null);return(0,v.useEffect)((()=>{const e=n.current;e&&void 0===t&&s(null!==e.closest(".jp-LinkedOutputView"))}),[t]),void 0===t?(0,y.jsx)("div",{ref:n}):e(t)};var tt=s(41797);const st=({queryId:e})=>{const t=Se(),{setWidgetState:s,widgetState:n=t.defaultWidgetState}=we(t),[i]=(0,v.useState)((()=>`${e}-linked-${tt.UUID.uuid4()}`));return(0,y.jsx)(x.$LY,{widgetState:n,queryId:i,onChange:s})};class nt{constructor(e,t){this.toldLoadingDone=!1,this.toldLoadingStarted=!1,this.sessionClient=e,this.widgetId=t}async started(e){this.toldLoadingStarted||this.sessionClient.isQuerySession||(this.toldLoadingStarted=!0,await this.sendLoadingState(!0,e))}async done(){this.toldLoadingDone||this.sessionClient.isQuerySession||(this.toldLoadingDone=!0,await this.sendLoadingState(!1))}async handleError(e){await this.done()}async sendLoadingState(e,t){const s=`atoti/rest/v1/widgets/${this.widgetId}/loading${e&&void 0!==t?`?queriesTimeLimit=${t}`:""}`;await this.sessionClient.fetch(s,{method:e?"POST":"DELETE"})}}const it="http://www.w3.org/2000/svg",ot=e=>`<?xml version="1.0" standalone="no"?>${e}`,at=e=>`<img src="data:image/svg+xml;charset=utf8,${e}">`,rt=(e,t,s,n)=>{const i=s.selectorText,o=s.style;if(((e,t,s)=>{if(s in e)return e[s];const n=t.some((e=>e.matches(s)));return e[s]=n,e[s]})(e,t,i)){i in n||(n[i]={});const e=n[i];for(const t of o)"important"===o.getPropertyPriority(t)?e[t]=o[t]+" !important":e[t]=o[t]}},dt=({clonedInitialElement:e,height:t,width:s})=>{if(!document.getElementById(Ke))throw new Error("The stylesheet #atoti-ant-style is missing");const n=((e,t,s)=>{const n=document.createElementNS(it,"svg");n.setAttribute("xmlns",it);const i=document.createElementNS(it,"foreignObject");n.setAttribute("height",String(t)),n.setAttribute("width",String(s)),i.setAttribute("width","100%"),i.setAttribute("height","100%"),i.setAttribute("x","0"),i.setAttribute("y","0");const o=document.createElement("style");var a;const r=(e=>Object.entries(e).map((([e,t])=>`${e} {${Object.entries(t).map((([e,t])=>`${e}: ${t}`)).join("; ")}}`)).join("\n"))((a=(e=>{const t={},s={},n=[e,...e.querySelectorAll("*")];return[...document.styleSheets].forEach((e=>{try{const i=e.cssRules;for(const e of i)rt(t,n,e,s)}catch(e){}})),s})(e),{...a,"*":{"-ms-overflow-style":"none","scrollbar-width":"none"},"*::-webkit-scrollbar":{display:"none"}}));o.setAttribute("type","text/css"),o.append(document.createTextNode(r)),n.append(i),i.append(o);const d=document.createElement("div");return d.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),d.setAttribute("style",`height: ${t}px; width: ${s}px;`),d.innerHTML=(e=>{const t=document.createElement("div");return t.textContent=e,t.innerHTML})((new XMLSerializer).serializeToString(e)),i.append(d),n})(e,t,s);return at(encodeURI(ot(n.outerHTML)))},lt=({currentElement:e,height:t,width:s})=>{const n=document.createElementNS(it,"svg");n.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttribute("height",String(t)),n.setAttribute("width",String(s)),((e,t)=>{const{height:s,width:n}=e[0].getBoundingClientRect();t.setAttribute("viewBox",`0 0 ${n} ${s}`);for(const s of e)for(const e of s.children)t.append(e.cloneNode(!0))})(e.querySelectorAll(".svg-container .main-svg"),n);const i=(new XMLSerializer).serializeToString(n);return at(encodeURIComponent(ot(i)))},ct=(e,{isPlotlyChart:t})=>(t?lt:dt)(e),ut=({mimeModel:e,queryId:t,saveStateSignal:s,widgetLoadingTracker:n,widgetRef:i})=>{const o=Se(),{setWidgetState:a,widgetState:r}=we(o),d=r||o.defaultWidgetState;(e=>{const t=(0,v.useContext)(Te);(0,v.useEffect)((()=>{e&&(e=>{e.shell.activateById(Me)})(t)}),[e,t])})(void 0===r);const l=((e,t)=>{const s=(0,v.useRef)(t);return(0,v.useEffect)((()=>{(async()=>{var t;if(!(null===(t=s.current)||void 0===t?void 0:t.mdx))return;const{queriesTimeLimit:n}=s.current.context||{};if(void 0!==n&&"number"!=typeof n)throw new Error(`Expected queriesTimeLimit to be a number but was: ${JSON.stringify(n)}`);await e.started(n)})()}),[e]),(0,v.useEffect)((()=>()=>{(async()=>{await e.done()})()}),[e]),(0,v.useCallback)((async()=>{await e.done()}),[e])})(n,d.query),{handleLoaded:c,widgetComponentKey:u}=((e,t,s,n,i)=>{const[{widgetKey:o}]=(0,x.ZrG)(i),a=(0,v.useCallback)((t=>{const{data:s}=e;t?s["text/html"]=t:Reflect.deleteProperty(s,"text/html")}),[e]),{error:r}=(0,x.bAZ)({queryId:t,serverKey:"default"}),d=(0,v.useRef)();return(0,v.useEffect)((()=>{const e=(e,t)=>{"started"===t&&a(!r&&d.current?ct(d.current,{isPlotlyChart:/plotly-.+-chart/.test(o)}):void 0)};return s.connect(e),()=>{s.disconnect(e)}}),[r,s,a,o]),(0,v.useEffect)((()=>()=>{a(void 0)}),[a]),{handleLoaded:(0,v.useCallback)((()=>{const e=n.current;d.current=e?{clonedInitialElement:e.cloneNode(!0),currentElement:e,height:e.clientHeight,width:e.clientWidth}:void 0}),[n]),widgetComponentKey:JSON.stringify(i)}})(e,t,s,i,d),h=(0,v.useCallback)((()=>{l(),c()}),[l,c]);return(0,y.jsx)(x.$LY,{key:u,widgetState:d,queryId:t,onLoaded:h,onChange:a})};var ht=s(83609);const gt="var(--jp-layout-color3)",pt=(0,v.forwardRef)((({children:e},t)=>{const s=Se(),{height:n,setHeight:i}=(e=>{const t=(0,v.useCallback)((t=>{e.setHeight(t)}),[e]),{height:s=he}=z(e.changed,e,"current")||{};return{height:s,setHeight:t}})(s),o=ee();return(0,y.jsx)(y.ClassNames,null,(({css:s})=>(0,y.jsx)(ht.Resizable,{handleClasses:{bottom:`atoti-resize-handle ${s({backgroundClip:"content-box",backgroundColor:gt,borderBottom:`1px solid ${gt}`,borderTop:`1px solid ${gt}`,boxSizing:"border-box",display:"none",height:"7px !important",marginBottom:5,marginLeft:"calc(50% - 20px)",paddingBottom:2,paddingTop:2,width:"40px !important"})}`},size:{height:n,width:"100%"},enable:{bottom:!0,bottomLeft:!1,bottomRight:!1,left:!1,right:!1,top:!1,topLeft:!1,topRight:!1},css:{"&:hover .atoti-resize-handle":{display:"inherit"},overflow:"hidden",paddingBottom:12},onResizeStop:(e,t,s,o)=>{i(n+o.height)}},(0,y.jsx)(S,{ref:t,"data-testid":h("Widget",o)},e))))})),mt=({html:e})=>{const t=(0,U.useIntl)(),s=ee();return(0,y.jsx)("div",{dangerouslySetInnerHTML:{__html:e},"data-testid":h("WidgetSnapshot",s),title:t.formatMessage({id:"widget.snapshot.title"})})},wt=({cellMetadata:e,jupyterSessionContext:t,mimeModel:s,queryId:n,saveStateSignal:i,sessionName:o,widgetComm:a})=>{const r=(0,v.useRef)(null),d=((e,t,s,n,i)=>{const o=(0,$.useMountedState)(),a=Q(),r=ye(),d=(0,v.useCallback)((()=>i.get(s)),[s,i]),l=B(i.changed,d),[c,u]=(0,v.useState)();return(0,v.useEffect)((()=>{(async()=>{if(!t.session||!l||c)return;const{session:s,widgetId:i}=l,d=await a.getOrCreate({jupyterSessionId:t.session.id,session:s,sessionName:n});r.getOrCreate(e),o()&&!c&&u(new nt(d,i))})()}),[e,o,t,a,n,l,c,r]),c})(e,t,s,o,a),l=ye().get(e);return d&&l?(0,y.jsx)(Ce,{cellMetadata:e},(0,y.jsx)(pt,{ref:r},(0,y.jsx)(K,{jupyterSessionContext:t,sessionName:o},(0,y.jsx)(De,{widgetLoadingTracker:d},(0,y.jsx)(ut,{mimeModel:s,queryId:n,saveStateSignal:i,widgetLoadingTracker:d,widgetRef:r}))))):s.data["text/html"]?(0,y.jsx)(mt,{html:s.data["text/html"]}):(0,y.jsx)(S,{height:pe(e)},(0,y.jsx)(A,null))},xt=({cellMetadata:e,jupyterSessionContext:t,mimeModel:s,queryId:n,saveStateSignal:i,sessionName:o,widgetComm:a})=>(0,y.jsx)(et,null,(r=>r?(0,y.jsx)(S,null,(0,y.jsx)(Ce,{cellMetadata:e,hasSnapshot:Boolean(s.data["text/html"])},(0,y.jsx)(K,{jupyterSessionContext:t,sessionName:o},(0,y.jsx)(st,{queryId:n})))):(0,y.jsx)(wt,{cellMetadata:e,jupyterSessionContext:t,mimeModel:s,queryId:n,saveStateSignal:i,sessionName:o,widgetComm:a})));class yt extends m.NotebookTools{constructor(e,t,s,n,i){super(t),this.cleanUpFunctions=[],this.cells=e,this.notebookContext=s,this.sharedContext=n,this.widgetComm=i}getCorrespondingCellModel(e){const t=(0,Je.toArray)(this.cells).filter(ae.isCodeCellModel).find((({outputs:t})=>$e(t,(t=>t===e))));if(!t)throw new Error(`Could not find matching cell for model: ${JSON.stringify(e)}`);return t}async renderModel(e){const{id:t,metadata:s}=this.getCorrespondingCellModel(e),n=e.data[Oe],{name:i,session:o}=n;return new Promise((n=>{Ze().render((0,y.jsx)(Ue,{value:this.sharedContext},(0,y.jsx)(Z,{value:i},(0,y.jsx)(xt,{cellMetadata:s,jupyterSessionContext:this.notebookContext.sessionContext,mimeModel:e,queryId:t,saveStateSignal:this.notebookContext.saveState,sessionName:o,widgetComm:this.widgetComm}))),this.node,(()=>{this.cleanUpFunctions.push((()=>{Ze().unmountComponentAtNode(this.node)})),n()}))}))}onAfterAttach(){const e={capture:!0};this.node.addEventListener("contextmenu",this,e),this.cleanUpFunctions.push((()=>{this.node.removeEventListener("contextmenu",this,e)}))}onBeforeDetach(){this.cleanUpFunctions.forEach((e=>{e()}))}handleEvent(e){if(e instanceof MouseEvent&&!e.shiftKey&&e.target){const t=new MouseEvent("contextmenu",{bubbles:!0,clientX:e.clientX,clientY:e.clientY,shiftKey:!0});e.stopPropagation(),e.preventDefault(),t.initEvent(t.type,!0,!0),e.target.dispatchEvent(t)}}}class vt{constructor(e){this.sharedContext=e}createNew(e,t){const{content:s,model:n}=e;if(null===n)throw new Error("Session model should not be null at this time");const{cells:i}=n,o=new Ye(i);s.rendermime.addFactory({createRenderer:()=>new yt(i,{tracker:this.sharedContext.notebookTracker},t,this.sharedContext,o),defaultRank:0,mimeTypes:[Oe],safe:!1});const{sessionContext:a}=t,r=(e,{newValue:t})=>{t&&o.register(t)};a.kernelChanged.connect(r);const d=(l=i,c=this.sharedContext.widgetStateTrackers,(e,t)=>{"idle"===t&&(0,Je.toArray)(l).filter((e=>{const t=c.get(e.metadata);return t&&void 0!==t.current&&(0,ae.isCodeCellModel)(e)&&e.outputs.length>0&&!$e(e.outputs,(e=>"error"===e.type||void 0!==e.data[Oe]))})).forEach((e=>{c.get(e.metadata).current=void 0}))});var l,c;return a.statusChanged.connect(d),new Ve.DisposableDelegate((()=>{a.kernelChanged.disconnect(r),a.statusChanged.disconnect(d)}))}}window.Cypress&&(window.__UNSTABLE_DATA_TEST_IDS_ENABLED__=!0);const Ct={async activate(e,t,s,i,o){const{docRegistry:a,shell:r}=e;console.log(`Activating atoti extension version 0.5.1 (relying on ActiveUI SDK version ${n.i8})`);const d=[x.TA$,x.Uou,x.igv,x.W$X,x.$3o,x.GSY,x.Y8R,x.uVH,x.fO6,x.U_o,x.UiH,x.Y5x,x.EAR,x.M1w,x.Oj0,x._dN,x.NWu,x.iph,x.wSQ,x.teE,x.C1v].map((e=>(0,Ee.produce)(e,(e=>{const t=(e.contextMenuItems||[]).filter((e=>ne.some((({key:t})=>t===e))));e.contextMenuItems=[...je,...t,se.key],e.titleBarButtons=void 0})))),l=new fe(d),c=((e,t)=>({"menu-item":oe([...ne,...e,se]),theme:oe(ie),widget:oe(t)}))(((e,t)=>je.map((s=>({Component:ke(s,e,t),key:s,translations:{"en-US":{key:"undo"===s?"Undo":"Redo",nothingToUndoRedo:"Nothing to "+("undo"===s?"undo":"redo")}}}))))(t,l),d),u={intlTracker:await _.create(c,o),jupyterLab:e,notebookTracker:t,pluginRegistry:c,sessionClients:new Y,themeTracker:await Xe.create(s),widgetStateTrackers:l},h=new He(u);r.add(h,"left",{rank:700}),i&&i.add(h,"atoti-sidebar"),a.addWidgetExtension("Notebook",new vt(u)),(()=>{const e=document.createElement("div");e.id=x.pt,e.classList.add(C),document.body.append(e)})()},autoStart:!0,id:"atoti",optional:[g.ILayoutRestorer,w.ISettingRegistry],requires:[m.INotebookTracker,p.IThemeManager]}},7147:(e,t,s)=>{var n={"./en-US":[80761,761],"./en-US.js":[80761,761],"./en-US.js.map":[57918,7918]};function i(e){if(!s.o(n,e))return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=n[e],i=t[0];return s.e(t[1]).then((()=>s(i)))}i.keys=()=>Object.keys(n),i.id=7147,e.exports=i}}]);