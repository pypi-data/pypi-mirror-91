!function(t){var e={};function s(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)s.d(i,a,function(e){return t[e]}.bind(null,a));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=206)}({0:function(t,e,s){"use strict";function i(t,e,s,i,a,n,o,r){var l,d="function"==typeof t?t.options:t;if(e&&(d.render=e,d.staticRenderFns=s,d._compiled=!0),i&&(d.functional=!0),n&&(d._scopeId="data-v-"+n),o?(l=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),a&&a.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(o)},d._ssrRegister=l):a&&(l=r?function(){a.call(this,(d.functional?this.parent:this).$root.$options.shadowRoot)}:a),l)if(d.functional){d._injectStyles=l;var c=d.render;d.render=function(t,e){return l.call(e),c(t,e)}}else{var u=d.beforeCreate;d.beforeCreate=u?[].concat(u,l):[l]}return{exports:t,options:d}}s.d(e,"a",(function(){return i}))},1:function(t,e,s){"use strict";t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var s=function(t,e){var s=t[1]||"",i=t[3];if(!i)return s;if(e&&"function"==typeof btoa){var a=(o=i,r=btoa(unescape(encodeURIComponent(JSON.stringify(o)))),l="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(r),"/*# ".concat(l," */")),n=i.sources.map((function(t){return"/*# sourceURL=".concat(i.sourceRoot||"").concat(t," */")}));return[s].concat(n).concat([a]).join("\n")}var o,r,l;return[s].join("\n")}(e,t);return e[2]?"@media ".concat(e[2]," {").concat(s,"}"):s})).join("")},e.i=function(t,s,i){"string"==typeof t&&(t=[[null,t,""]]);var a={};if(i)for(var n=0;n<this.length;n++){var o=this[n][0];null!=o&&(a[o]=!0)}for(var r=0;r<t.length;r++){var l=[].concat(t[r]);i&&a[l[0]]||(s&&(l[2]?l[2]="".concat(s," and ").concat(l[2]):l[2]=s),e.push(l))}},e}},196:function(t,e,s){"use strict";var i=s(37);s.n(i).a},197:function(t,e,s){(e=s(1)(!1)).push([t.i,"\n.border-active[data-v-4002c9de] {\n  border: 1px solid #ced4da;\n}\n.canvas-container[data-v-4002c9de] {\n  border: 1px solid #ced4da;\n  border-top-left-radius: 0px;\n  border-top-right-radius: 0px;\n}\n.color-input[data-v-4002c9de] {\n  height: 0px;\n  padding: 0px;\n  visibility: hidden;\n  width: 0px;\n  -webkit-appearance: none;\n}\n.color-picker[data-v-4002c9de] {\n  background-color: black;\n  border: 1px solid black;\n  cursor: pointer;\n  display: inline-block;\n  height: 25px;\n  margin-left: 15px;\n  margin-right: 20px;\n  vertical-align: middle;\n  width: 25px;\n}\n.size-input[data-v-4002c9de] {\n  display: inline;\n  margin-left: 5px;\n  margin-right: 5px;\n  width: 50px;\n}\n.stroke-width-display[data-v-4002c9de] {\n  background-color: black;\n  border-radius: 50%;\n  display: inline-block;\n  vertical-align: middle;\n}\n.stroke-width-display-container[data-v-4002c9de] {\n  align-items: center;\n  display: inline-flex;\n  height: 30px;\n  justify-content: center;\n  margin-left: 10px;\n  margin-right: 15px;\n  vertical-align: middle;\n  width: 30px;\n}\n.stroke-width-input[data-v-4002c9de] {\n  vertical-align: middle;\n  width: 150px;\n}\n.toolbar[data-v-4002c9de] {\n  border-bottom-left-radius: 0px;\n  border-bottom-right-radius: 0px;\n  border-color: #ced4da;\n  margin-bottom: -1px;\n  padding-left: 10px;\n  padding-right: 10px;\n}\n.toolbar-btn[data-v-4002c9de] {\n  margin-left: 5px;\n  margin-right: 5px;\n  width: 45px;\n}\n",""]),t.exports=e},198:function(t,e,s){"use strict";var i=s(38);s.n(i).a},199:function(t,e,s){(e=s(1)(!1)).push([t.i,".dropzone[data-v-5fafa0ae]{align-items:center;border:2px dashed #b5bbc2;border-radius:5px;cursor:pointer;display:flex;height:100px;justify-content:center;min-height:0px;text-align:center}.dropzone.dragging[data-v-5fafa0ae]{background-color:#f7f7f7;border:2px solid #b5bbc2}.input[data-v-5fafa0ae]{position:absolute;visibility:hidden}\n",""]),t.exports=e},200:function(t,e,s){"use strict";var i=s(39);s.n(i).a},201:function(t,e,s){(e=s(1)(!1)).push([t.i,"\n.input[data-v-c058102c] {\n  position: absolute;\n  visibility: hidden;\n}\n",""]),t.exports=e},206:function(t,e,s){"use strict";s.r(e);var i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("div",{ref:"container"},[s("div",{staticClass:"card toolbar"},[s("div",{staticClass:"card-body px-0 py-1"},[s("button",{class:t.toolbarBtnClasses+t.enabledToolClasses("pen"),attrs:{title:"Pencil",type:"button"},on:{click:function(e){t.tool="pen"}}},[s("i",{staticClass:"fas fa-pen"})]),t._v(" "),s("button",{class:t.toolbarBtnClasses+t.enabledToolClasses("eraser"),attrs:{title:"Eraser",type:"button"},on:{click:function(e){t.tool="eraser"}}},[s("i",{staticClass:"fas fa-eraser"})]),t._v(" "),s("button",{class:t.toolbarBtnClasses+t.enabledToolClasses("eyedropper"),attrs:{title:"Eye dropper",type:"button"},on:{click:function(e){t.tool="eyedropper"}}},[s("i",{staticClass:"fas fa-eye-dropper"})]),t._v(" "),s("button",{class:t.toolbarBtnClasses+t.enabledToolClasses("move"),attrs:{title:"Move canvas",type:"button"},on:{click:function(e){t.tool="move"}}},[s("i",{staticClass:"fas fa-arrows-alt"})]),t._v(" "),s("button",{class:t.toolbarBtnClasses,attrs:{title:"Reset view",type:"button"},on:{click:t.resetView}},[s("i",{staticClass:"fas fa-eye"})]),t._v(" "),s("button",{class:t.toolbarBtnClasses,attrs:{title:"Toggle fullscreen",type:"button"},on:{click:t.toggleFullscreen}},[s("i",{staticClass:"fas fa-expand"})]),t._v(" "),s("button",{class:t.toolbarBtnClasses,attrs:{title:"Reset canvas",type:"button"},on:{click:t.resetCanvas}},[s("i",{staticClass:"fas fa-broom"})]),t._v(" "),s("span",{staticClass:"color-picker",style:{"background-color":t.color},attrs:{title:"Color"},on:{click:t.pickColor}}),t._v(" "),s("input",{directives:[{name:"model",rawName:"v-model",value:t.color,expression:"color"}],ref:"colorInput",staticClass:"color-input",attrs:{type:"color"},domProps:{value:t.color},on:{input:function(e){e.target.composing||(t.color=e.target.value)}}}),t._v(" "),s("span",{staticClass:"d-inline-block mr-2"},[s("input",{directives:[{name:"model",rawName:"v-model.number",value:t.strokeWidth,expression:"strokeWidth",modifiers:{number:!0}}],staticClass:"stroke-width-input",attrs:{title:"Stroke width",type:"range",min:"1",max:"31",step:"2"},domProps:{value:t.strokeWidth},on:{__r:function(e){t.strokeWidth=t._n(e.target.value)},blur:function(e){return t.$forceUpdate()}}}),t._v(" "),s("span",{staticClass:"stroke-width-display-container"},[s("span",{staticClass:"stroke-width-display",style:{width:t.strokeWidth+"px",height:t.strokeWidth+"px"}})])]),t._v(" "),s("span",{staticClass:"d-inline-block mr-3 my-1"},[s("input",{directives:[{name:"model",rawName:"v-model.number",value:t.width,expression:"width",modifiers:{number:!0}}],staticClass:"form-control form-control-sm size-input",attrs:{title:"Width"},domProps:{value:t.width},on:{change:t.updateCanvasSize,input:function(e){e.target.composing||(t.width=t._n(e.target.value))},blur:function(e){return t.$forceUpdate()}}}),t._v(" "),s("i",{staticClass:"fas fa-xs fa-times"}),t._v(" "),s("input",{directives:[{name:"model",rawName:"v-model.number",value:t.height,expression:"height",modifiers:{number:!0}}],staticClass:"form-control form-control-sm size-input",attrs:{title:"Height"},domProps:{value:t.height},on:{change:t.updateCanvasSize,input:function(e){e.target.composing||(t.height=t._n(e.target.value))},blur:function(e){return t.$forceUpdate()}}})])])]),t._v(" "),s("div",{ref:"canvasContainer",staticClass:"card canvas-container"},[s("canvas",{ref:"canvas",on:{mousedown:t.mousedown,mousemove:t.mousemove,mouseup:t.mouseup,mouseout:t.mouseup}})]),t._v(" "),s("svg",{ref:"cursorPen",staticClass:"d-none",attrs:{height:t.strokeWidth,width:t.strokeWidth}},[s("circle",{attrs:{"stroke-width":"0px",cx:t.strokeWidth/2,cy:t.strokeWidth/2,r:t.strokeWidth/2,fill:t.color}})]),t._v(" "),s("svg",{ref:"cursorEraser",staticClass:"d-none",attrs:{height:t.strokeWidth+2,width:t.strokeWidth+2}},[s("circle",{attrs:{stroke:"black","stroke-width":"1px",fill:"white",cx:t.strokeWidth/2+1,cy:t.strokeWidth/2+1,r:t.strokeWidth/2}})])]),t._v(" "),t._t("default",null,{canvas:t.memCanvas})],2)};i._withStripped=!0;var a={data:()=>({canvas:null,ctx:null,memCanvas:null,memCtx:null,currX:0,currY:0,prevX:0,prevY:0,topX:0,topY:0,width:0,height:0,maxSize:9999,tool:"pen",color:"#000000",strokeWidth:3,points:[],mouseDown:!1,unsavedChanges_:!1,resizeHandler:null,beforeunloadHandler:null}),props:{imageUrl:{type:String,default:null},unsavedChanges:{type:Boolean,default:!1}},computed:{toolbarBtnClasses:()=>"btn btn-link text-primary toolbar-btn my-1"},watch:{imageUrl(){this.clearCanvas()},tool(){this.updateCursor()},color(){this.updateCursor()},strokeWidth(){this.updateCursor()},unsavedChanges(){this.unsavedChanges_=this.unsavedChanges},unsavedChanges_(){this.$emit("unsaved-changes",this.unsavedChanges_)},width(){this.width<1||isNaN(this.width)?this.width=1:this.width>this.maxSize&&(this.width=this.maxSize)},height(){this.height<1||isNaN(this.height)?this.height=1:this.height>this.maxSize&&(this.height=this.maxSize)}},methods:{resetView(){this.topX=0,this.topY=0,this.redrawVisibleCanvas()},toggleFullscreen(){this.isFullscreen()?document.exitFullscreen():this.$refs.container.requestFullscreen()},resetCanvas(){confirm(i18n.t("warning.resetCanvas"))&&(this.clearCanvas(),this.unsavedChanges_=!1)},pickColor(){this.$refs.colorInput.click()},updateCanvasSize(){const t=this.memCtx.getImageData(0,0,this.memCanvas.width,this.memCanvas.height);this.memCanvas.width=this.width,this.memCanvas.height=this.height,this.memCtx.fillStyle="white",this.memCtx.fillRect(0,0,this.width,this.height),this.memCtx.putImageData(t,0,0),this.redrawVisibleCanvas(),this.unsavedChanges_=!0},enabledToolClasses(t){return this.tool===t?" border-active":""},isFullscreen:()=>document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen,updateCoordinates(t){this.prevX=this.currX,this.prevY=this.currY,this.currX=t.clientX-this.canvas.getBoundingClientRect().left,this.currY=t.clientY-this.canvas.getBoundingClientRect().top},updateCursor(){this.$nextTick(()=>{let t="default";if("pen"===this.tool||"eraser"===this.tool){const e="pen"===this.tool?this.$refs.cursorPen:this.$refs.cursorEraser;t=`url("data:image/svg+xml;base64,${window.btoa((new XMLSerializer).serializeToString(e))}") ${this.strokeWidth/2} ${this.strokeWidth/2}, auto`}else"move"===this.tool&&(t="move");this.$refs.canvasContainer.style.cursor=t})},getCurrentPixelColor(){const t=this.ctx.getImageData(this.currX,this.currY,1,1).data;return"#"+("000000"+(t[0]<<16|t[1]<<8|t[2]).toString(16)).slice(-6)},loadFromUrl(t){const e=new Image;e.onload=()=>{let t=e.width;t>this.maxSize&&(t=this.maxSize);let s=e.height;s>this.maxSize&&(s=this.maxSize),this.width=this.memCanvas.width=t,this.height=this.memCanvas.height=s,this.memCtx.fillStyle="white",this.memCtx.fillRect(0,0,this.width,this.height),this.memCtx.drawImage(e,0,0),this.redrawVisibleCanvas()},e.src=t},clearCanvas(){this.imageUrl?this.loadFromUrl(this.imageUrl):(this.memCtx.fillStyle="white",this.memCtx.fillRect(0,0,this.memCanvas.width,this.memCanvas.height)),this.redrawVisibleCanvas()},draw(){this.redrawVisibleCanvas(),this.points.push({x:this.currX,y:this.currY}),this.drawPoints(),this.drawLimits()},redrawVisibleCanvas(){this.ctx.drawImage(this.memCanvas,this.topX,this.topY,this.canvas.width,this.canvas.height,0,0,this.canvas.width,this.canvas.height),this.drawLimits()},drawLimits(){const t=this.memCanvas.height-this.topY,e=this.memCanvas.width-this.topX;this.ctx.fillStyle="#ced4da",this.ctx.fillRect(0,0,-this.topX,this.canvas.height),this.ctx.fillRect(0,0,this.canvas.width,-this.topY),this.ctx.fillRect(0,t,this.canvas.width,this.canvas.height-t),this.ctx.fillRect(e,0,this.canvas.width-e,this.canvas.height)},drawPoints(){if("pen"===this.tool?(this.ctx.strokeStyle=this.color,this.ctx.fillStyle=this.color):(this.ctx.strokeStyle="white",this.ctx.fillStyle="white"),this.ctx.lineWidth=this.strokeWidth,this.ctx.lineJoin="round",this.ctx.lineCap="round",this.ctx.beginPath(),this.points.length<4)return this.ctx.arc(this.points[0].x,this.points[0].y,this.strokeWidth/2,0,2*Math.PI),void this.ctx.fill();this.ctx.moveTo(this.points[0].x,this.points[0].y);let t=0;for(t=1;t<this.points.length-2;t++){const e=(this.points[t].x+this.points[t+1].x)/2,s=(this.points[t].y+this.points[t+1].y)/2;this.ctx.quadraticCurveTo(this.points[t].x,this.points[t].y,e,s)}this.ctx.quadraticCurveTo(this.points[t].x,this.points[t].y,this.points[t+1].x,this.points[t+1].y),this.ctx.stroke()},resizeVisibleCanvas(){this.canvas.width=this.$refs.canvasContainer.getBoundingClientRect().width||512,this.isFullscreen()?this.canvas.height=this.$refs.container.getBoundingClientRect().height:this.canvas.height=Math.round(window.innerHeight/window.innerWidth*this.canvas.width),this.redrawVisibleCanvas()},mousedown(t){this.updateCoordinates(t),this.mouseDown=!0,"pen"===this.tool||"eraser"===this.tool?(this.draw(),this.unsavedChanges_=!0):"eyedropper"===this.tool&&(this.color=this.getCurrentPixelColor())},mousemove(t){this.mouseDown&&(this.updateCoordinates(t),"pen"===this.tool||"eraser"===this.tool?this.draw():"eyedropper"===this.tool?this.color=this.getCurrentPixelColor():"move"===this.tool&&(this.topX-=this.currX-this.prevX,this.topY-=this.currY-this.prevY,this.redrawVisibleCanvas()))},mouseup(){!this.mouseDown||"pen"!==this.tool&&"eraser"!==this.tool||(this.memCtx.clearRect(this.topX,this.topY,this.canvas.width,this.canvas.height),this.memCtx.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,this.topX,this.topY,this.canvas.width,this.canvas.height)),this.mouseDown=!1,this.points=[]}},mounted(){this.canvas=this.$refs.canvas,this.ctx=this.canvas.getContext("2d"),this.memCanvas=document.createElement("canvas"),this.memCtx=this.memCanvas.getContext("2d"),this.resizeVisibleCanvas(),this.width=this.memCanvas.width=this.canvas.width,this.height=this.memCanvas.height=this.canvas.height,this.clearCanvas(),this.updateCursor(),this.resizeHandler=window.addEventListener("resize",this.resizeVisibleCanvas),this.beforeunloadHandler=window.addEventListener("beforeunload",t=>{if(this.unsavedChanges_)return t.preventDefault(),(t||window.event).returnValue="",""})},beforeDestroy(){this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.beforeunloadHandler&&window.removeEventListener("beforeunload",this.beforeunloadHandler)}},n=(s(196),s(0)),o=Object(n.a)(a,i,[],!1,null,"4002c9de",null);o.options.__file="kadi/assets/scripts/lib/components/CanvasPainter.vue";var r=o.exports,l=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("upload-dropzone",{on:{"add-file":t.addFile}}),t._v(" "),s("input",{ref:"input",staticClass:"input",attrs:{type:"file"},on:{change:t.inputChange}}),t._v(" "),t.uploads.length>0?s("div",{staticClass:"card bg-light py-2 px-4 mt-4 mb-3"},[s("div",{staticClass:"form-row align-items-center"},[s("div",{staticClass:"col-xl-8"},[t._v("\n        "+t._s(t.completedUploadsCount+"/"+t.uploads.length+" "+t.i18n.t("uploads.completed",{count:t.uploads.length}))+"\n        "),t.completedUploadsCount===t.uploads.length?s("i",{staticClass:"fas fa-xs fa-check ml-2"}):t._e()]),t._v(" "),s("div",{staticClass:"col-xl-2 d-xl-flex justify-content-end"},[s("small",{staticClass:"text-muted"},[t._v(t._s(t._f("filesizeFormat")(t.totalUploadSize)))])]),t._v(" "),s("div",{staticClass:"col-xl-2 d-xl-flex justify-content-end"},[s("div",{staticClass:"btn-group btn-group-sm"},[s("button",{staticClass:"btn btn-primary",attrs:{title:t.i18n.t("uploads.resumeAll"),disabled:!t.resumable},on:{click:function(e){return t.resumeUploads(null)}}},[s("i",{staticClass:"fas fa-play"})]),t._v(" "),s("button",{staticClass:"btn btn-primary",attrs:{title:t.i18n.t("uploads.pauseAll"),disabled:!t.pausable},on:{click:function(e){return t.pauseUploads(!1)}}},[s("i",{staticClass:"fas fa-pause"})]),t._v(" "),s("button",{staticClass:"btn btn-primary",attrs:{title:t.i18n.t("uploads.cancelAll"),disabled:!t.cancelable},on:{click:function(e){return t.cancelUploads(!1)}}},[s("i",{staticClass:"fas fa-ban"})])])])])]):t._e(),t._v(" "),t._l(t.paginatedUploads,(function(e,i){return s("div",{key:e.id,staticClass:"card",class:{"mb-3":i<t.uploads.length-1}},[s("div",{staticClass:"card-body py-2"},[s("div",{staticClass:"form-row align-items-center",class:{"mb-2":"completed"!==e.state}},[s("div",{staticClass:"col-xl-8"},[e.chunkCount?s("strong",[e.viewFileEndpoint?s("a",{attrs:{href:e.viewFileEndpoint}},[t._v(t._s(e.name))]):s("span",[t._v(t._s(e.name))])]):s("span",{staticClass:"text-muted"},[t._v(t._s(e.name))])]),t._v(" "),s("div",{staticClass:"col-xl-2 d-xl-flex justify-content-end"},[s("small",{staticClass:"text-muted"},[t._v(t._s(t._f("filesizeFormat")(e.size)))])]),t._v(" "),s("div",{staticClass:"col-xl-2 d-xl-flex justify-content-end"},[s("span",{staticClass:"badge badge-primary"},[t._v(t._s(t.stateNames[e.state]))])])]),t._v(" "),"completed"!==e.state?s("div",{staticClass:"form-row align-items-center"},[s("div",{staticClass:"col-xl-10 py-1"},[s("div",{staticClass:"progress border border-muted",staticStyle:{height:"17px"}},[s("div",{staticClass:"progress-bar",style:{width:Math.floor(e.progress)+"%"}},[t._v("\n              "+t._s(Math.floor(e.progress))+"%\n            ")])])]),t._v(" "),s("div",{staticClass:"col-xl-2 mt-2 mt-xl-0 d-xl-flex justify-content-end"},["processing"===e.state?s("i",{staticClass:"fas fa-circle-notch fa-spin"}):t._e(),t._v(" "),s("div",{staticClass:"btn-group btn-group-sm"},[["pending","uploading"].includes(e.state)?s("button",{staticClass:"btn btn-light",attrs:{title:t.i18n.t("uploads.pause")},on:{click:function(s){return t.pauseUploads(!1,e)}}},[s("i",{staticClass:"fas fa-pause"})]):t._e(),t._v(" "),"paused"===e.state?s("button",{staticClass:"btn btn-light",attrs:{title:t.i18n.t("uploads.resume")},on:{click:function(s){return t.resumeUploads(e)}}},[t.isResumable(e)?s("i",{staticClass:"fas fa-play"}):s("i",{staticClass:"fas fa-folder-open"})]):t._e(),t._v(" "),["pending","paused","uploading"].includes(e.state)?s("button",{staticClass:"btn btn-light",attrs:{title:t.i18n.t("uploads.cancel")},on:{click:function(s){return t.cancelUploads(!1,e)}}},[s("i",{staticClass:"fas fa-ban"})]):t._e()])])]):t._e()]),t._v(" "),null!==e.replacedFile||null!==e.createdAt?s("div",{staticClass:"card-footer bg-white py-1"},[s("div",{staticClass:"d-flex justify-content-between"},[s("div",[null!==e.replacedFile?s("div",[s("span",{staticClass:"text-muted"},[t._v(t._s(t.i18n.t("uploads.replaces")))]),t._v(" "),s("a",{staticClass:"text-muted",attrs:{href:e.replacedFile._links.view}},[s("strong",[t._v(t._s(e.replacedFile.name))])])]):t._e()]),t._v(" "),s("div",[null!==e.createdAt?s("small",{staticClass:"text-muted"},[t._v("\n            "+t._s(t.i18n.t("misc.createdAt"))+" "),s("local-timestamp",{attrs:{timestamp:e.createdAt}})],1):t._e()])])]):t._e()])})),t._v(" "),s("pagination-control",{attrs:{total:t.uploads.length,"per-page":t.perPage},on:{"update-page":function(e){t.page=e}}})],2)};l._withStripped=!0;var d=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("div",{staticClass:"dropzone",class:{dragging:t.isDragging},on:{click:t.clickDropzone,dragover:function(e){e.stopPropagation(),e.preventDefault(),t.isDragging=!0},dragenter:function(e){e.stopPropagation(),e.preventDefault(),t.isDragging=!0},dragleave:function(e){e.stopPropagation(),e.preventDefault(),t.isDragging=!1},drop:function(e){return e.stopPropagation(),e.preventDefault(),t.dropFiles(e)}}},[s("div",{staticClass:"text-muted"},[t._v(t._s(t.i18n.t("uploads.dropzone")))])]),t._v(" "),s("input",{ref:"input",staticClass:"input",attrs:{type:"file",multiple:""},on:{change:t.inputChange}})])};d._withStripped=!0;var c={data:()=>({isDragging:!1}),methods:{clickDropzone(){this.$refs.input.click()},inputChange(t){for(const e of t.target.files)this.$emit("add-file",e)},dropFiles(t){this.isDragging=!1;const e=t.dataTransfer;if(0!==e.files.length)if(e.items.length>0&&e.items[0].webkitGetAsEntry)for(const t of e.items){const e=t.webkitGetAsEntry();e.isFile?this.$emit("add-file",t.getAsFile()):e.isDirectory&&this.addFilesFromDirectory(e)}else for(const t of e.files)this.$emit("add-file",t)},addFilesFromDirectory(t){const e=t.createReader(),s=()=>{e.readEntries(t=>{if(t.length>0){for(const e of t)e.isFile?e.file(t=>this.$emit("add-file",t)):e.isDirectory&&this.addFilesFromDirectory(e);s()}})};s()}}},u=(s(198),Object(n.a)(c,d,[],!1,null,"5fafa0ae",null));u.options.__file="kadi/assets/scripts/lib/components/UploadDropzone.vue";var h={components:{UploadDropzone:u.exports},data:()=>({uploads:[],uploadQueue:[],addedFileTimeoutHandle:null,beforeunloadHandler:null,resumedUpload:null,page:1,stateNames:{paused:i18n.t("uploads.statePaused"),pending:i18n.t("uploads.statePending"),uploading:i18n.t("uploads.stateUploading"),processing:i18n.t("uploads.stateProcessing"),completed:i18n.t("uploads.stateCompleted")}}),props:{newUploadEndpoint:String,getUploadsEndpoint:String,perPage:{type:Number,default:5}},watch:{uploadQueue(){null!==this.addedFileTimeoutHandle&&clearTimeout(this.addedFileTimeoutHandle),this.addedFileTimeoutHandle=setTimeout(()=>this.uploadNextFile(),100)}},methods:{addFile(t){const e={id:kadi.utils.randomAlnum(),name:t.name,size:t.size,state:"pending",chunks:[],file:t,progress:0,source:null,chunkSize:null,chunkCount:null,replacedFile:null,createdAt:null,uploadChunkEndpoint:null,finishUploadEndpoint:null,deleteUploadEndpoint:null,getStatusEndpoint:null,viewFileEndpoint:null};this.uploadQueue.push(e),this.uploads.push(e)},inputChange(t){const e=t.target.files[0];(e.size===this.resumedUpload.size||confirm(i18n.t("warning.uploadSizeDiffers")))&&(this.resumedUpload.file=e,this.resumedUpload.state="pending",this.uploadQueue.push(this.resumedUpload))},async uploadNextFile(){if(this.uploadQueue.length>0&&!this.uploadInProgress){const t=this.uploadQueue[0];if(t.state="uploading",!t.chunkCount){const e=e=>{413===e.request.status?kadi.alert(e.response.data.description,{type:"warning"}):kadi.alert(i18n.t("error.initiateUpload"),{xhr:e.request}),this.cancelUploads(!0,t)};try{await this.initiateUpload(t)}catch(s){if(409!==s.request.status)return void e(s);if(!confirm(i18n.t("warning.replaceUpload",{filename:t.name})))return void this.cancelUploads(!0,t);try{await this.initiateUpload(t,s.response.data.file._actions.edit_data),t.replacedFile=s.response.data.file}catch(t){return void e(t)}}}for(;;){if("uploading"!==t.state)return;let e=null;for(let s=0;s<t.chunkCount;s++){if(!t.chunks.find(t=>t.index===s&&"active"===t.state)){e=s;break}}if(null===e)break;const s=e*t.chunkSize,i=Math.min(s+t.chunkSize,t.size),a=t.file.slice(s,i);let n=0;for(;;){if("uploading"!==t.state)return;try{await this.uploadChunk(t,a,e);break}catch(e){if(axios.isCancel(e))return;if(413===e.request.status)return kadi.alert(e.response.data.description,{type:"warning"}),void this.pauseUploads(!1,t);n+=5e3,kadi.alert(i18n.t("error.uploadChunk",{timeout:n/1e3}),{xhr:e.request,timeout:n}),await kadi.utils.sleep(n)}}}t.state="processing";try{await this.finishUpload(t)}catch(e){return 413===e.request.status?kadi.alert(e.response.data.description,{type:"warning"}):kadi.alert(i18n.t("error.finishUpload"),{xhr:e.request}),void this.pauseUploads(!0,t)}this.finalizeUpload(t),this.uploadQueue.shift()}},initiateUpload(t,e=null){let s=e,i=null,a=null;return s?(i=axios.put,a={size:t.size}):(s=this.newUploadEndpoint,i=axios.post,a={name:t.name,size:t.size}),i(s,a).then(e=>{const s=e.data;t.id=s.id,t.chunkSize=s._meta.chunk_size,t.chunkCount=s.chunk_count,t.createdAt=s.created_at,t.uploadChunkEndpoint=s._actions.upload_chunk,t.finishUploadEndpoint=s._actions.finish_upload,t.deleteUploadEndpoint=s._actions.delete,t.getStatusEndpoint=s._links.status})},uploadChunk(t,e,s){const i=new FormData;i.append("blob",e),i.append("index",s),i.append("size",e.size);const a=axios.CancelToken.source();t.source=a;const n={onUploadProgress:s=>{t.progress=Math.max(this.getUploadProgress(t,Math.min(s.loaded,e.size)),t.progress)},cancelToken:a.token};return axios.put(t.uploadChunkEndpoint,i,n).then(e=>{t.chunks=e.data.chunks,t.progress=this.getUploadProgress(t)}).finally(()=>t.source=null)},finishUpload:t=>axios.post(t.finishUploadEndpoint),finalizeUpload(t){let e=Math.floor(5e3*Math.random());const s=()=>{e<3e4&&(e+=2e3),axios.get(t.getStatusEndpoint,{params:{_internal:!0}}).then(i=>{const a=i.data;"processing"===a.state?setTimeout(s,e):"inactive"===a.state&&(a._meta.file?(t.state="completed",t.viewFileEndpoint=a._meta.file._links.view,this.$emit("upload-complete",a._meta.file)):a._meta.error?(kadi.alert(a._meta.error),this.cancelUploads(!0,t)):setTimeout(s,e))}).catch(t=>kadi.alert(i18n.t("error.updateStatus"),{xhr:t.request}))};setTimeout(s,e)},cancelUploads(t,e=null){const s=t=>{kadi.utils.removeFromList(this.uploadQueue,t),kadi.utils.removeFromList(this.uploads,t)};let i=[],a="";if(null===e?(i=this.uploads.slice(),a=i18n.t("warning.cancelUploads")):(i.push(e),a=i18n.t("warning.cancelUpload",{filename:e.name})),t||confirm(a))for(const e of i)!t&&["processing","completed"].includes(e.state)||(e.source&&(e.source.cancel(),e.source=null),e.deleteUploadEndpoint?axios.delete(e.deleteUploadEndpoint).then(()=>s(e)).catch(t=>{404!==t.request.status?kadi.alert(i18n.t("error.removeUpload"),{xhr:t.request}):s(e)}):s(e))},pauseUploads(t,e=null){let s=[];null===e?s=this.uploads.slice():s.push(e);for(const e of s)!t&&["processing","completed"].includes(e.state)||(e.state="paused",e.source&&(e.source.cancel(),e.source=null),kadi.utils.removeFromList(this.uploadQueue,e))},resumeUploads(t=null){if(null!==t)this.isResumable(t)?(t.state="pending",this.uploadQueue.push(t)):(this.resumedUpload=t,this.$refs.input.click());else for(const t of this.uploads.slice())this.isResumable(t)&&(t.state="pending",this.uploadQueue.push(t))},getTotalChunkSize:t=>t.chunks.reduce((t,e)=>"active"===e.state?t+=e.size:t,0),getUploadProgress(t,e=0){return 0===t.size?t.chunks.length>0&&"active"===t.chunks[0].state?100:0:(this.getTotalChunkSize(t)+e)/t.size*100},isResumable(t){return 0===t.size?"paused"===t.state&&(null!==t.file||t.chunks.length>0&&"active"===t.chunks[0].state):"paused"===t.state&&(null!==t.file||this.getTotalChunkSize(t)===t.size)}},computed:{paginatedUploads(){return kadi.utils.paginateList(this.uploads,this.page,this.perPage)},totalUploadSize(){return this.uploads.reduce((t,e)=>t+e.size,0)},completedUploadsCount(){return this.uploads.reduce((t,e)=>"completed"===e.state?t+=1:t,0)},uploadInProgress(){return this.uploads.slice().some(t=>"uploading"===t.state)},pausable(){return this.uploads.slice().some(t=>["pending","uploading"].includes(t.state))},resumable(){return this.uploads.slice().some(t=>this.isResumable(t))},cancelable(){return this.uploads.slice().some(t=>["pending","uploading","paused"].includes(t.state))}},mounted(){axios.get(this.getUploadsEndpoint).then(t=>{t.data.items.forEach(e=>{e.replacedFile=e.file,e.file=null,e.progress=this.getUploadProgress(e),e.source=null,e.chunkSize=t.data._meta.chunk_size,e.chunkCount=e.chunk_count,e.createdAt=e.created_at,e.uploadChunkEndpoint=e._actions.upload_chunk,e.finishUploadEndpoint=e._actions.finish_upload,e.deleteUploadEndpoint=e._actions.delete,e.getStatusEndpoint=e._links.status,e.uploadviewFileEndpoint=null,"active"===e.state?e.state="paused":"processing"===e.state&&this.finalizeUpload(e),this.uploads.push(e)})}),this.beforeunloadHandler=window.addEventListener("beforeunload",t=>{if(this.uploadQueue.length>0)return t.preventDefault(),(t||window.event).returnValue="",""})},beforeDestroy(){this.beforeunloadHandler&&window.removeEventListener("beforeunload",this.beforeunloadHandler)}},p=(s(200),Object(n.a)(h,l,[],!1,null,"c058102c",null));p.options.__file="kadi/assets/scripts/lib/components/UploadManager.vue";var f=p.exports;new Vue({el:"#vm",components:{CanvasPainter:r,UploadManager:f},data:{filename:"",currentFile:null,imageUrl:null,unsavedChanges:!1,renderDrawingTab:!1},methods:{changeTab(t){"upload-drawing"===t&&(this.renderDrawingTab=!0)},uploadComplete(t){this.currentFile&&this.currentFile.id===t.id&&(this.currentFile=t)},dataURLtoFile(t,e){const s=atob(t.split(",")[1]);let i=s.length;const a=new Uint8Array(i);for(;i;)a[i-1]=s.charCodeAt(i-1),i-=1;return new File([a],e)},saveCanvas(t){let e=this.filename;e.endsWith(".png")||(e+=".png");const s=()=>{const s=this.dataURLtoFile(t.toDataURL(),e);this.$refs.navTabs.changeTab("upload-files"),this.$refs.uploadManager.addFile(s),this.unsavedChanges=!1};this.currentFile&&this.currentFile.name===e?axios.get(this.currentFile._links.self).then(t=>{this.currentFile.checksum!==t.data.checksum?confirm(i18n.t("warning.fileChanged"))&&s():s()}):s()}},mounted(){kadi.js_resources.current_file_endpoint&&axios.get(kadi.js_resources.current_file_endpoint).then(t=>{this.currentFile=t.data,["image/png","image/jpeg"].includes(this.currentFile.magic_mimetype)&&(this.imageUrl=this.currentFile._links.download,this.filename=this.currentFile.name,this.$refs.navTabs.changeTab("upload-drawing"))}).catch(t=>kadi.alert(i18n.t("error.loadFile"),{xhr:t.request}))}})},3:function(t,e,s){"use strict";function i(t,e){for(var s=[],i={},a=0;a<e.length;a++){var n=e[a],o=n[0],r={id:t+":"+a,css:n[1],media:n[2],sourceMap:n[3]};i[o]?i[o].parts.push(r):s.push(i[o]={id:o,parts:[r]})}return s}s.r(e),s.d(e,"default",(function(){return p}));var a="undefined"!=typeof document;if("undefined"!=typeof DEBUG&&DEBUG&&!a)throw new Error("vue-style-loader cannot be used in a non-browser environment. Use { target: 'node' } in your Webpack config to indicate a server-rendering environment.");var n={},o=a&&(document.head||document.getElementsByTagName("head")[0]),r=null,l=0,d=!1,c=function(){},u=null,h="undefined"!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function p(t,e,s,a){d=s,u=a||{};var o=i(t,e);return f(o),function(e){for(var s=[],a=0;a<o.length;a++){var r=o[a];(l=n[r.id]).refs--,s.push(l)}e?f(o=i(t,e)):o=[];for(a=0;a<s.length;a++){var l;if(0===(l=s[a]).refs){for(var d=0;d<l.parts.length;d++)l.parts[d]();delete n[l.id]}}}}function f(t){for(var e=0;e<t.length;e++){var s=t[e],i=n[s.id];if(i){i.refs++;for(var a=0;a<i.parts.length;a++)i.parts[a](s.parts[a]);for(;a<s.parts.length;a++)i.parts.push(v(s.parts[a]));i.parts.length>s.parts.length&&(i.parts.length=s.parts.length)}else{var o=[];for(a=0;a<s.parts.length;a++)o.push(v(s.parts[a]));n[s.id]={id:s.id,refs:1,parts:o}}}}function m(){var t=document.createElement("style");return t.type="text/css",o.appendChild(t),t}function v(t){var e,s,i=document.querySelector('style[data-vue-ssr-id~="'+t.id+'"]');if(i){if(d)return c;i.parentNode.removeChild(i)}if(h){var a=l++;i=r||(r=m()),e=b.bind(null,i,a,!1),s=b.bind(null,i,a,!0)}else i=m(),e=x.bind(null,i),s=function(){i.parentNode.removeChild(i)};return e(t),function(i){if(i){if(i.css===t.css&&i.media===t.media&&i.sourceMap===t.sourceMap)return;e(t=i)}else s()}}var g,C=(g=[],function(t,e){return g[t]=e,g.filter(Boolean).join("\n")});function b(t,e,s,i){var a=s?"":i.css;if(t.styleSheet)t.styleSheet.cssText=C(e,a);else{var n=document.createTextNode(a),o=t.childNodes;o[e]&&t.removeChild(o[e]),o.length?t.insertBefore(n,o[e]):t.appendChild(n)}}function x(t,e){var s=e.css,i=e.media,a=e.sourceMap;if(i&&t.setAttribute("media",i),u.ssrId&&t.setAttribute("data-vue-ssr-id",e.id),a&&(s+="\n/*# sourceURL="+a.sources[0]+" */",s+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(a))))+" */"),t.styleSheet)t.styleSheet.cssText=s;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(s))}}},37:function(t,e,s){var i=s(197);"string"==typeof i&&(i=[[t.i,i,""]]),i.locals&&(t.exports=i.locals);(0,s(3).default)("0a0e3fce",i,!1,{})},38:function(t,e,s){var i=s(199);"string"==typeof i&&(i=[[t.i,i,""]]),i.locals&&(t.exports=i.locals);(0,s(3).default)("0cd7b1e4",i,!1,{})},39:function(t,e,s){var i=s(201);"string"==typeof i&&(i=[[t.i,i,""]]),i.locals&&(t.exports=i.locals);(0,s(3).default)("23cbc800",i,!1,{})}});
//# sourceMappingURL=add-files.js.map