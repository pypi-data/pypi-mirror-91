def __bootstrap(pkg_name, pkg_set=None, sep="_"):
  import copy as _copy
  from importlib import abc as _imp_abc
  from importlib import machinery as _imp_mac
  from importlib import util as _imp_util
  import sys as _sys

  def _rename(name, sep="_"):
    idx = name.find(".")
    return name if idx == -1 else name[:idx+1] + name[idx+1:].replace(".", sep)

  class _ExtensionLoader(_imp_mac.ExtensionFileLoader):
    def __init__(self, name, path, is_package=False, sep="_"):
      super(_ExtensionLoader, self).__init__(name, path)
      self._sep = sep
      self._is_package = is_package

    def create_module(self, spec):
      s = _copy.copy(spec)
      s.name = _rename(s.name, sep=self._sep)
      return super(_ExtensionLoader, self).create_module(s)

    def is_package(self, fullname):
      return self._is_package

  # Chooses the right init function
  class _CythonPackageMetaPathFinder(_imp_abc.MetaPathFinder):
    def __init__(self, name, packages=None, sep="_"):
      super(_CythonPackageMetaPathFinder, self).__init__()
      self._prefix = name + "."
      self._sep = sep
      self._start = len(self._prefix)
      self._packages = set(packages or set())

    def __eq__(self, other):
      return (self.__class__.__name__ == other.__class__.__name__ and
              self._prefix == getattr(other, "_prefix", None) and
              self._sep == getattr(other, "_sep", None) and
              self._packages == getattr(other, "_packages", None))

    def __hash__(self):
      return (hash(self.__class__.__name__) ^
              hash(self._prefix) ^
              hash(self._sep) ^
              hash("".join(sorted(self._packages))))

    def find_spec(self, fullname, path, target=None):
      if fullname.startswith(self._prefix):
        name = _rename(fullname, sep=self._sep)
        is_package = fullname in self._packages
        loader = _ExtensionLoader(name, __file__, is_package=is_package)
        return _imp_util.spec_from_loader(
            name, loader, origin=__file__, is_package=is_package)

  # injecting custom finder/loaders into sys.meta_path:
  finder = _CythonPackageMetaPathFinder(pkg_name, packages=pkg_set, sep=sep)
  if finder not in _sys.meta_path: _sys.meta_path.append(finder)


__bootstrap("{package}", {subpackages}, "{sep}")


