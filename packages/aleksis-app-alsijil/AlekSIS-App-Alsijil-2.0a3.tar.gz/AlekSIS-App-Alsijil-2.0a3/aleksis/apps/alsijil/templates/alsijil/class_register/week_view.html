{# -*- engine:django -*- #}

{% extends "core/base.html" %}
{% load material_form i18n week_helpers static data_helpers rules time_helpers %}

{% block browser_title %}{% blocktrans %}Week view{% endblocktrans %}{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/alsijil/alsijil.css' %}"/>
{% endblock %}

{% block content %}
  <script type="text/javascript" src="{% static "js/helper.js" %}"></script>
  {{ week_select|json_script:"week_select" }}
  <script type="text/javascript" src="{% static "js/chronos/week_select.js" %}"></script>
  <div class="row">
    <div class="col s12">
      <form method="post" action="">
        {% csrf_token %}
        {% form form=select_form %}{% endform %}
        <button type="submit" class="btn waves-effect waves-light">
          {% blocktrans %}Select{% endblocktrans %}
        </button>
      </form>
    </div>
  </div>


  <div class="row no-margin">
    <h4 class="col s12 m6">{% blocktrans with el=el week=week.week %}CW {{ week }}:
      {{ instance }}{% endblocktrans %} </h4>
    {% include "chronos/partials/week_select.html" with wanted_week=week %}
  </div>

  {% if group %}
    <p class="hide-on-med-and-down">
      <a class="btn primary-color waves-effect waves-light" href="{% url "students_list" group.pk %}">
        <i class="material-icons left">people</i>
        {% trans "Students list" %}
      </a>
      <a class="btn waves-effect waves-light" href="{% url "full_register_group" group.pk %}" target="_blank">
        <i class="material-icons left">print</i>
        {% trans "Generate printout" %}
      </a>
    </p>

    <p class="hide-on-med-and-up">
      <a class="btn primary-color waves-effect waves-light hundred-percent" href="{% url "students_list" group.pk %}">
        <i class="material-icons left">people</i>
        {% trans "Students list" %}
      </a>
    </p>
    <p class="hide-on-med-and-up">
      <a class="btn waves-effect waves-light hundred-percent" href="{% url "full_register_group" group.pk %}"
         target="_blank">
        <i class="material-icons left">print</i>
        {% trans "Generate printout" %}
      </a>
    </p>
  {% endif %}

  {% if lesson_periods %}
    <div class="row">
      <div class="col s12">
        <ul class="tabs">
          <li class="tab col s6">
            <a class="active" href="#week-overview">{% trans "Lesson documentations" %}</a>
          </li>
          <li class="tab col s6">
            <a class="active" href="#personal-notes">{% trans "Personal notes" %}</a>
          </li>
        </ul>
      </div>
      <div class="col s12" id="week-overview">
        {% regroup lesson_periods by period.get_weekday_display as periods_by_day %}
        {% for weekday, periods in periods_by_day %}
          {% with weekdays|get_dict:forloop.counter0 as advanced_weekday %}
            {% weekday_to_date week periods.0.period.weekday as current_date %}

            {% if advanced_weekday.holiday and not request.site.preferences.alsijil__allow_entries_in_holidays %}
              <div class="card">
                <div class="card-content">
                  {% weekday_to_date week periods.0.period.weekday as current_date %}
                  <span class="card-title">
                    {{ weekday }}, {{ current_date }} <span class="badge new blue no-float">{{ advanced_weekday.holiday }}</span>
                  </span>
                </div>
              </div>
            {% else %}
              <div class="card show-on-extra-large">
                <div class="card-content">
                  <span class="card-title">
                    {{ weekday }}, {{ current_date }}
                  </span>
                  <table class="striped datatable">
                    <thead>
                    <tr>
                      <th></th>
                      <th>{% blocktrans %}Period{% endblocktrans %}</th>
                      {% if not group %}
                        <th>{% blocktrans %}Groups{% endblocktrans %}</th>
                      {% endif %}
                      <th>{% blocktrans %}Subject{% endblocktrans %}</th>
                      <th>{% blocktrans %}Teachers{% endblocktrans %}</th>
                      <th>{% blocktrans %}Lesson topic{% endblocktrans %}</th>
                      <th>{% blocktrans %}Homework{% endblocktrans %}</th>
                      <th>{% blocktrans %}Group note{% endblocktrans %}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for period in periods %}
                      {% has_perm "alsijil.view_lessondocumentation" user period as can_view_lesson_documentation %}
                      {% if can_view_lesson_documentation %}
                        <tr>
                          <td class="center-align">
                            {% include "alsijil/partials/lesson_status_icon.html" with period=period %}
                          </td>
                          <td class="tr-link">
                            <a class="tr-link"
                               href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                              {{ period.period.period }}.
                            </a>
                          </td>
                          {% if not group %}
                            <td>
                              <a class="tr-link"
                                 href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                                {{ period.lesson.group_names }}
                              </a>
                            </td>
                          {% endif %}
                          <td>
                            <a class="tr-link"
                               href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                              {{ period.get_subject.name }}
                            </a>
                          </td>
                          <td>
                            <a class="tr-link"
                               href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                              {{ period.get_teacher_names }}
                            </a>
                          </td>
                          <td>
                            <a class="tr-link"
                               href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                              {% firstof period.get_lesson_documentation.topic "–" %}
                            </a>
                          </td>
                          <td>
                            <a class="tr-link"
                               href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                              {% firstof period.get_lesson_documentation.homework "–" %}
                            </a>
                          </td>
                          <td>
                            <a class="tr-link"
                               href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                              {% firstof period.get_lesson_documentation.group_note "–" %}
                            </a>
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              <ul class="collapsible hide-on-extra-large-only">
                <li class="">
                  {% weekday_to_date week periods.0.period.weekday as current_date %}
                  <div class="collapsible-header flow-text">
                    {{ weekday }}, {{ current_date }} <i class="material-icons collapsible-icon-right">expand_more</i>
                  </div>
                  <div class="collapsible-body">
                    <div class="collection">
                      {% for period in periods %}
                        {% has_perm "alsijil.view_lessondocumentation" user period as can_view_lesson_documentation %}
                        {% if can_view_lesson_documentation %}
                          <a class="collection-item avatar"
                             href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                            {% include "alsijil/partials/lesson_status_icon.html" with period=period css_class="materialize-circle" color_suffix=" " %}
                            <table class="hide-on-med-and-down">
                              <tr>
                                <th>{% trans "Subject" %}</th>
                                <td>{{ period.period.period }}. {{ period.get_subject.name }}</td>
                              </tr>
                              {% if not group %}
                                <tr>
                                  <th>{% trans "Group" %}</th>
                                  <td>{{ period.lesson.group_names }}</td>
                                </tr>
                              {% endif %}
                              <tr>
                                <th>{% trans "Teachers" %}</th>
                                <td>{{ period.lesson.teacher_names }}</td>
                              </tr>
                              <tr>
                                <th>{% trans "Lesson topic" %}</th>
                                <td>{% firstof period.get_lesson_documentation.topic "–" %}</td>
                              </tr>
                              {% with period.get_lesson_documentation as lesson_documentation %}
                                {% if lesson_documentation.homework %}
                                  <tr>
                                    <th>{% trans "Homework" %}</th>
                                    <td>{% firstof period.get_lesson_documentation.homework "–" %}</td>
                                  </tr>
                                {% endif %}
                                {% if lesson_documentation.group_note %}
                                  <tr>
                                    <th>{% trans "Group note" %}</th>
                                    <td>{% firstof period.get_lesson_documentation.group_note "–" %}</td>
                                  </tr>
                                {% endif %}
                              {% endwith %}
                            </table>
                            <div class="hide-on-large-only">
                              <ul class="collection">
                                <li class="collection-item">
                                  {{ period.period.period }}. {{ period.get_subject.name }}
                                </li>
                                {% if not group %}
                                  <li class="collection-item">

                                    {{ period.lesson.group_names }}

                                  </li>
                                {% endif %}
                                <li class="collection-item">
                                  {{ period.lesson.teacher_names }}
                                </li>
                                <li class="collection-item">
                                  {{ period.get_lesson_documentation.topic }}
                                </li>
                                {% with period.get_lesson_documentation as lesson_documentation %}
                                  {% if lesson_documentation.homework %}
                                    <li class="collection-item">
                                      <strong>{% trans "Homework" %}</strong>
                                      {% firstof period.get_lesson_documentation.homework "–" %}
                                    </li>
                                  {% endif %}
                                  {% if lesson_documentation.group_note %}
                                    <li class="collection-item">
                                      <strong>{% trans "Group note" %}</strong>
                                      {% firstof period.get_lesson_documentation.group_note "–" %}
                                    </li>
                                  {% endif %}
                                {% endwith %}
                              </ul>
                            </div>
                          </a>
                        {% endif %}
                      {% endfor %}
                    </div>
                  </div>
                </li>
              </ul>
            {% endif %}
          {% endwith %}
        {% endfor %}
      </div>
      <div class="col s12" id="personal-notes">
        <div class="card">
          <div class="card-content">
            <span class="card-title">
              {% blocktrans %}Personal notes{% endblocktrans %}
            </span>
            {% for person in persons %}
              <h5 class="card-title">
                {% has_perm "alsijil.view_person_overview" user person.person as can_view_person_overview %}
                {% if can_view_person_overview %}
                  <a href="{% url "overview_person" person.person.pk %}">{{ person.person.full_name }}</a>
                {% else %}
                  {{ person.person.full_name }}
                {% endif %}
                {% has_perm "alsijil.register_absence" user person.person as can_register_absence %}
                {% if can_register_absence %}
                  <a class="btn primary-color waves-effect waves-light right"
                     href="{% url "register_absence" person.person.pk %}">
                    <i class="material-icons left">rate_review</i>
                    {% trans "Register absence" %}
                  </a>
                {% endif %}
              </h5>
              <p class="card-text">
                {% trans "Absent" %}: {{ person.person.absences_count }}
                ({{ person.person.unexcused_count }} {% trans "unexcused" %})
              </p>
              <p class="card-text">
                {% trans "Summed up tardiness" %}: {% firstof person.person.tardiness_sum|to_time|time:"H\h i\m" "–" %}
              </p>
              <p class="card-text">
                {% trans "Count of tardiness" %}: {{ person.person.tardiness_count }} &times;
              </p>
              {% for extra_mark in extra_marks %}
                <p class="card-text">
                  {{ extra_mark.name }}: {{ person.person|get_dict:extra_mark.count_label }}
                </p>
              {% endfor %}
              {% for note in person.personal_notes %}
                {% if note.remarks %}
                  <blockquote>
                    {{ note.remarks }}
                    {% weekday_to_date week note.lesson_period.period.weekday as note_date %}
                    <em class="right">
                      <a href="{% url 'lesson_by_week_and_period' week.year week.week note.lesson_period.id %}">
                        {{ note_date }}, {{ note.lesson_period.get_subject.name }}
                      </a>
                    </em>
                  </blockquote>
                {% endif %}
              {% endfor %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="card red darken-1">
      <div class="card-content white-text">
        <span class="card-title">
          {% blocktrans %}No lessons available{% endblocktrans %}
        </span>
        <p>
          {% blocktrans %}
            There are no lessons for the selected group or teacher in this week.
          {% endblocktrans %}
        </p>
      </div>
    </div>
  {% endif %}

  <script>
      $(document).ready(function () {
          $("#id_group").change(function () {
              $("#id_teacher").val("").formSelect();
          });
          $("#id_teacher").change(function () {
              $("#id_group").val("").formSelect();
          });
      });

  </script>
{% endblock %}
